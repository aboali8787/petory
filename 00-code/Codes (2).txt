<?php
/**
 * WordPress User Page
 *
 * Handles authentication, registering, resetting passwords, forgot password,
 * and other user handling.
 *
 * @package WordPress
 */

/** Make sure that the WordPress bootstrap has run before continuing. */
require __DIR__ . '/wp-load.php';

// Redirect to HTTPS login if forced to use SSL.
if ( force_ssl_admin() && ! is_ssl() ) {
	if ( str_starts_with( $_SERVER['REQUEST_URI'], 'http' ) ) {
		wp_safe_redirect( set_url_scheme( $_SERVER['REQUEST_URI'], 'https' ) );
		exit;
	} else {
		wp_safe_redirect( 'https://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'] );
		exit;
	}
}

/**
 * Outputs the login page header.
 *
 * @since 2.1.0
 *
 * @global string      $error         Login error message set by deprecated pluggable wp_login() function
 *                                    or plugins replacing it.
 * @global bool|string $interim_login Whether interim login modal is being displayed. String 'success'
 *                                    upon successful login.
 * @global string      $action        The action that brought the visitor to the login page.
 *
 * @param string|null   $title    Optional. WordPress login page title to display in the `<title>` element.
 *                                Defaults to 'Log In'.
 * @param string        $message  Optional. Message to display in header. Default empty.
 * @param WP_Error|null $wp_error Optional. The error to pass. Defaults to a WP_Error instance.
 */
function login_header( $title = null, $message = '', $wp_error = null ) {
	global $error, $interim_login, $action;

	if ( null === $title ) {
		$title = __( 'Log In' );
	}

	// Don't index any of these forms.
	add_filter( 'wp_robots', 'wp_robots_sensitive_page' );
	add_action( 'login_head', 'wp_strict_cross_origin_referrer' );

	add_action( 'login_head', 'wp_login_viewport_meta' );

	if ( ! is_wp_error( $wp_error ) ) {
		$wp_error = new WP_Error();
	}

	// Shake it!
	$shake_error_codes = array( 'empty_password', 'empty_email', 'invalid_email', 'invalidcombo', 'empty_username', 'invalid_username', 'incorrect_password', 'retrieve_password_email_failure' );
	/**
	 * Filters the error codes array for shaking the login form.
	 *
	 * @since 3.0.0
	 *
	 * @param string[] $shake_error_codes Error codes that shake the login form.
	 */
	$shake_error_codes = apply_filters( 'shake_error_codes', $shake_error_codes );

	if ( $shake_error_codes && $wp_error->has_errors() && in_array( $wp_error->get_error_code(), $shake_error_codes, true ) ) {
		add_action( 'login_footer', 'wp_shake_js', 12 );
	}

	$login_title = get_bloginfo( 'name', 'display' );

	/* translators: Login screen title. 1: Login screen name, 2: Network or site name. */
	$login_title = sprintf( __( '%1$s &lsaquo; %2$s &#8212; WordPress' ), $title, $login_title );

	if ( wp_is_recovery_mode() ) {
		/* translators: %s: Login screen title. */
		$login_title = sprintf( __( 'Recovery Mode &#8212; %s' ), $login_title );
	}

	/**
	 * Filters the title tag content for login page.
	 *
	 * @since 4.9.0
	 *
	 * @param string $login_title The page title, with extra context added.
	 * @param string $title       The original page title.
	 */
	$login_title = apply_filters( 'login_title', $login_title, $title );

	?><!DOCTYPE html>
	<html <?php language_attributes(); ?>>
	<head>
	<meta http-equiv="Content-Type" content="<?php bloginfo( 'html_type' ); ?>; charset=<?php bloginfo( 'charset' ); ?>" />
	<title><?php echo $login_title; ?></title>
	<?php

	wp_enqueue_style( 'login' );

	/*
	 * Remove all stored post data on logging out.
	 * This could be added by add_action('login_head'...) like wp_shake_js(),
	 * but maybe better if it's not removable by plugins.
	 */
	if ( 'loggedout' === $wp_error->get_error_code() ) {
		ob_start();
		?>
		<script>if("sessionStorage" in window){try{for(var key in sessionStorage){if(key.indexOf("wp-autosave-")!=-1){sessionStorage.removeItem(key)}}}catch(e){}};</script>
		<?php
		wp_print_inline_script_tag( wp_remove_surrounding_empty_script_tags( ob_get_clean() ) );
	}

	/**
	 * Enqueues scripts and styles for the login page.
	 *
	 * @since 3.1.0
	 */
	do_action( 'login_enqueue_scripts' );

	/**
	 * Fires in the login page header after scripts are enqueued.
	 *
	 * @since 2.1.0
	 */
	do_action( 'login_head' );

	$login_header_url = __( 'https://wordpress.org/' );

	/**
	 * Filters link URL of the header logo above login form.
	 *
	 * @since 2.1.0
	 *
	 * @param string $login_header_url Login header logo URL.
	 */
	$login_header_url = apply_filters( 'login_headerurl', $login_header_url );

	$login_header_title = '';

	/**
	 * Filters the title attribute of the header logo above login form.
	 *
	 * @since 2.1.0
	 * @deprecated 5.2.0 Use {@see 'login_headertext'} instead.
	 *
	 * @param string $login_header_title Login header logo title attribute.
	 */
	$login_header_title = apply_filters_deprecated(
		'login_headertitle',
		array( $login_header_title ),
		'5.2.0',
		'login_headertext',
		__( 'Usage of the title attribute on the login logo is not recommended for accessibility reasons. Use the link text instead.' )
	);

	$login_header_text = empty( $login_header_title ) ? __( 'Powered by WordPress' ) : $login_header_title;

	/**
	 * Filters the link text of the header logo above the login form.
	 *
	 * @since 5.2.0
	 *
	 * @param string $login_header_text The login header logo link text.
	 */
	$login_header_text = apply_filters( 'login_headertext', $login_header_text );

	$classes = array( 'login-action-' . $action, 'wp-core-ui' );

	if ( is_rtl() ) {
		$classes[] = 'rtl';
	}

	if ( $interim_login ) {
		$classes[] = 'interim-login';

		?>
		<style type="text/css">html{background-color: transparent;}</style>
		<?php

		if ( 'success' === $interim_login ) {
			$classes[] = 'interim-login-success';
		}
	}

	$classes[] = ' locale-' . sanitize_html_class( strtolower( str_replace( '_', '-', get_locale() ) ) );

	/**
	 * Filters the login page body classes.
	 *
	 * @since 3.5.0
	 *
	 * @param string[] $classes An array of body classes.
	 * @param string   $action  The action that brought the visitor to the login page.
	 */
	$classes = apply_filters( 'login_body_class', $classes, $action );

	?>
	</head>
	<body class="login no-js <?php echo esc_attr( implode( ' ', $classes ) ); ?>">
	<?php
	wp_print_inline_script_tag( "document.body.className = document.body.className.replace('no-js','js');" );
	?>

	<?php
	/**
	 * Fires in the login page header after the body tag is opened.
	 *
	 * @since 4.6.0
	 */
	do_action( 'login_header' );
	?>
	<?php
	if ( 'confirm_admin_email' !== $action && ! empty( $title ) ) :
		?>
		<h1 class="screen-reader-text"><?php echo $title; ?></h1>
		<?php
	endif;
	?>
	<div id="login">
		<h1 role="presentation" class="wp-login-logo"><a href="<?php echo esc_url( $login_header_url ); ?>"><?php echo $login_header_text; ?></a></h1>
	<?php
	/**
	 * Filters the message to display above the login form.
	 *
	 * @since 2.1.0
	 *
	 * @param string $message Login message text.
	 */
	$message = apply_filters( 'login_message', $message );

	if ( ! empty( $message ) ) {
		echo $message . "\n";
	}

	// In case a plugin uses $error rather than the $wp_errors object.
	if ( ! empty( $error ) ) {
		$wp_error->add( 'error', $error );
		unset( $error );
	}

	if ( $wp_error->has_errors() ) {
		$error_list = array();
		$messages   = '';

		foreach ( $wp_error->get_error_codes() as $code ) {
			$severity = $wp_error->get_error_data( $code );
			foreach ( $wp_error->get_error_messages( $code ) as $error_message ) {
				if ( 'message' === $severity ) {
					$messages .= '<p>' . $error_message . '</p>';
				} else {
					$error_list[] = $error_message;
				}
			}
		}

		if ( ! empty( $error_list ) ) {
			$errors = '';

			if ( count( $error_list ) > 1 ) {
				$errors .= '<ul class="login-error-list">';

				foreach ( $error_list as $item ) {
					$errors .= '<li>' . $item . '</li>';
				}

				$errors .= '</ul>';
			} else {
				$errors .= '<p>' . $error_list[0] . '</p>';
			}

			/**
			 * Filters the error messages displayed above the login form.
			 *
			 * @since 2.1.0
			 *
			 * @param string $errors Login error messages.
			 */
			$errors = apply_filters( 'login_errors', $errors );

			wp_admin_notice(
				$errors,
				array(
					'type'           => 'error',
					'id'             => 'login_error',
					'paragraph_wrap' => false,
				)
			);
		}

		if ( ! empty( $messages ) ) {
			/**
			 * Filters instructional messages displayed above the login form.
			 *
			 * @since 2.5.0
			 *
			 * @param string $messages Login messages.
			 */
			$messages = apply_filters( 'login_messages', $messages );

			wp_admin_notice(
				$messages,
				array(
					'type'               => 'info',
					'id'                 => 'login-message',
					'additional_classes' => array( 'message' ),
					'paragraph_wrap'     => false,
				)
			);
		}
	}
} // End of login_header().

/**
 * Outputs the footer for the login page.
 *
 * @since 3.1.0
 *
 * @global bool|string $interim_login Whether interim login modal is being displayed. String 'success'
 *                                    upon successful login.
 *
 * @param string $input_id Which input to auto-focus.
 */
function login_footer( $input_id = '' ) {
	global $interim_login;

	// Don't allow interim logins to navigate away from the page.
	if ( ! $interim_login ) {
		?>
		<p id="backtoblog">
			<?php
			$html_link = sprintf(
				'<a href="%s">%s</a>',
				esc_url( home_url( '/' ) ),
				sprintf(
					/* translators: %s: Site title. */
					_x( '&larr; Go to %s', 'site' ),
					get_bloginfo( 'title', 'display' )
				)
			);
			/**
			 * Filters the "Go to site" link displayed in the login page footer.
			 *
			 * @since 5.7.0
			 *
			 * @param string $link HTML link to the home URL of the current site.
			 */
			echo apply_filters( 'login_site_html_link', $html_link );
			?>
		</p>
		<?php

		the_privacy_policy_link( '<div class="privacy-policy-page-link">', '</div>' );
	}

	?>
	</div><?php // End of <div id="login">. ?>

	<?php
	if (
		! $interim_login &&
		/**
		 * Filters whether to display the Language selector on the login screen.
		 *
		 * @since 5.9.0
		 *
		 * @param bool $display Whether to display the Language selector on the login screen.
		 */
		apply_filters( 'login_display_language_dropdown', true )
	) {
		$languages = get_available_languages();

		if ( ! empty( $languages ) ) {
			?>
			<div class="language-switcher">
				<form id="language-switcher" method="get">

					<label for="language-switcher-locales">
						<span class="dashicons dashicons-translation" aria-hidden="true"></span>
						<span class="screen-reader-text">
							<?php
							/* translators: Hidden accessibility text. */
							_e( 'Language' );
							?>
						</span>
					</label>

					<?php
					$args = array(
						'id'                          => 'language-switcher-locales',
						'name'                        => 'wp_lang',
						'selected'                    => determine_locale(),
						'show_available_translations' => false,
						'explicit_option_en_us'       => true,
						'languages'                   => $languages,
					);

					/**
					 * Filters default arguments for the Languages select input on the login screen.
					 *
					 * The arguments get passed to the wp_dropdown_languages() function.
					 *
					 * @since 5.9.0
					 *
					 * @param array $args Arguments for the Languages select input on the login screen.
					 */
					wp_dropdown_languages( apply_filters( 'login_language_dropdown_args', $args ) );
					?>

					<?php if ( $interim_login ) { ?>
						<input type="hidden" name="interim-login" value="1" />
					<?php } ?>

					<?php if ( isset( $_GET['redirect_to'] ) && '' !== $_GET['redirect_to'] ) { ?>
						<input type="hidden" name="redirect_to" value="<?php echo sanitize_url( $_GET['redirect_to'] ); ?>" />
					<?php } ?>

					<?php if ( isset( $_GET['action'] ) && '' !== $_GET['action'] ) { ?>
						<input type="hidden" name="action" value="<?php echo esc_attr( $_GET['action'] ); ?>" />
					<?php } ?>

						<input type="submit" class="button" value="<?php esc_attr_e( 'Change' ); ?>">

					</form>
				</div>
		<?php } ?>
	<?php } ?>

	<?php

	if ( ! empty( $input_id ) ) {
		ob_start();
		?>
		<script>
		try{document.getElementById('<?php echo $input_id; ?>').focus();}catch(e){}
		if(typeof wpOnload==='function')wpOnload();
		</script>
		<?php
		wp_print_inline_script_tag( wp_remove_surrounding_empty_script_tags( ob_get_clean() ) );
	}

	/**
	 * Fires in the login page footer.
	 *
	 * @since 3.1.0
	 */
	do_action( 'login_footer' );

	?>
	</body>
	</html>
	<?php
}

/**
 * Outputs the JavaScript to handle the form shaking on the login page.
 *
 * @since 3.0.0
 */
function wp_shake_js() {
	wp_print_inline_script_tag( "document.querySelector('form').classList.add('shake');" );
}

/**
 * Outputs the viewport meta tag for the login page.
 *
 * @since 3.7.0
 */
function wp_login_viewport_meta() {
	?>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<?php
}

/*
 * Main part.
 *
 * Check the request and redirect or display a form based on the current action.
 */

$action = isset( $_REQUEST['action'] ) && is_string( $_REQUEST['action'] ) ? $_REQUEST['action'] : 'login';
$errors = new WP_Error();

if ( isset( $_GET['key'] ) ) {
	$action = 'resetpass';
}

if ( isset( $_GET['checkemail'] ) ) {
	$action = 'checkemail';
}

$default_actions = array(
	'confirm_admin_email',
	'postpass',
	'logout',
	'lostpassword',
	'retrievepassword',
	'resetpass',
	'rp',
	'register',
	'checkemail',
	'confirmaction',
	'login',
	WP_Recovery_Mode_Link_Service::LOGIN_ACTION_ENTERED,
);

// Validate action so as to default to the login screen.
if ( ! in_array( $action, $default_actions, true ) && false === has_filter( 'login_form_' . $action ) ) {
	$action = 'login';
}

nocache_headers();

header( 'Content-Type: ' . get_bloginfo( 'html_type' ) . '; charset=' . get_bloginfo( 'charset' ) );

if ( defined( 'RELOCATE' ) && RELOCATE ) { // Move flag is set.
	if ( isset( $_SERVER['PATH_INFO'] ) && ( $_SERVER['PATH_INFO'] !== $_SERVER['PHP_SELF'] ) ) {
		$_SERVER['PHP_SELF'] = str_replace( $_SERVER['PATH_INFO'], '', $_SERVER['PHP_SELF'] );
	}

	$url = dirname( set_url_scheme( 'http://' . $_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF'] ) );

	if ( get_option( 'siteurl' ) !== $url ) {
		update_option( 'siteurl', $url );
	}
}

// Set a cookie now to see if they are supported by the browser.
$secure = ( 'https' === parse_url( wp_login_url(), PHP_URL_SCHEME ) );
setcookie( TEST_COOKIE, 'WP Cookie check', 0, COOKIEPATH, COOKIE_DOMAIN, $secure, true );

if ( SITECOOKIEPATH !== COOKIEPATH ) {
	setcookie( TEST_COOKIE, 'WP Cookie check', 0, SITECOOKIEPATH, COOKIE_DOMAIN, $secure, true );
}

if ( isset( $_GET['wp_lang'] ) ) {
	setcookie( 'wp_lang', sanitize_text_field( $_GET['wp_lang'] ), 0, COOKIEPATH, COOKIE_DOMAIN, $secure, true );
}

/**
 * Fires when the login form is initialized.
 *
 * @since 3.2.0
 */
do_action( 'login_init' );

/**
 * Fires before a specified login form action.
 *
 * The dynamic portion of the hook name, `$action`, refers to the action
 * that brought the visitor to the login form.
 *
 * Possible hook names include:
 *
 *  - `login_form_checkemail`
 *  - `login_form_confirm_admin_email`
 *  - `login_form_confirmaction`
 *  - `login_form_entered_recovery_mode`
 *  - `login_form_login`
 *  - `login_form_logout`
 *  - `login_form_lostpassword`
 *  - `login_form_postpass`
 *  - `login_form_register`
 *  - `login_form_resetpass`
 *  - `login_form_retrievepassword`
 *  - `login_form_rp`
 *
 * @since 2.8.0
 */
do_action( "login_form_{$action}" );

$http_post     = ( 'POST' === $_SERVER['REQUEST_METHOD'] );
$interim_login = isset( $_REQUEST['interim-login'] );

/**
 * Filters the separator used between login form navigation links.
 *
 * @since 4.9.0
 *
 * @param string $login_link_separator The separator used between login form navigation links.
 */
$login_link_separator = apply_filters( 'login_link_separator', ' | ' );

switch ( $action ) {

	case 'confirm_admin_email':
		/*
		 * Note that `is_user_logged_in()` will return false immediately after logging in
		 * as the current user is not set, see wp-includes/pluggable.php.
		 * However this action runs on a redirect after logging in.
		 */
		if ( ! is_user_logged_in() ) {
			wp_safe_redirect( wp_login_url() );
			exit;
		}

		if ( ! empty( $_REQUEST['redirect_to'] ) ) {
			$redirect_to = $_REQUEST['redirect_to'];
		} else {
			$redirect_to = admin_url();
		}

		if ( current_user_can( 'manage_options' ) ) {
			$admin_email = get_option( 'admin_email' );
		} else {
			wp_safe_redirect( $redirect_to );
			exit;
		}

		/**
		 * Filters the interval for dismissing the admin email confirmation screen.
		 *
		 * If `0` (zero) is returned, the "Remind me later" link will not be displayed.
		 *
		 * @since 5.3.1
		 *
		 * @param int $interval Interval time (in seconds). Default is 3 days.
		 */
		$remind_interval = (int) apply_filters( 'admin_email_remind_interval', 3 * DAY_IN_SECONDS );

		if ( ! empty( $_GET['remind_me_later'] ) ) {
			if ( ! wp_verify_nonce( $_GET['remind_me_later'], 'remind_me_later_nonce' ) ) {
				wp_safe_redirect( wp_login_url() );
				exit;
			}

			if ( $remind_interval > 0 ) {
				update_option( 'admin_email_lifespan', time() + $remind_interval );
			}

			$redirect_to = add_query_arg( 'admin_email_remind_later', 1, $redirect_to );
			wp_safe_redirect( $redirect_to );
			exit;
		}

		if ( ! empty( $_POST['correct-admin-email'] ) ) {
			if ( ! check_admin_referer( 'confirm_admin_email', 'confirm_admin_email_nonce' ) ) {
				wp_safe_redirect( wp_login_url() );
				exit;
			}

			/**
			 * Filters the interval for redirecting the user to the admin email confirmation screen.
			 *
			 * If `0` (zero) is returned, the user will not be redirected.
			 *
			 * @since 5.3.0
			 *
			 * @param int $interval Interval time (in seconds). Default is 6 months.
			 */
			$admin_email_check_interval = (int) apply_filters( 'admin_email_check_interval', 6 * MONTH_IN_SECONDS );

			if ( $admin_email_check_interval > 0 ) {
				update_option( 'admin_email_lifespan', time() + $admin_email_check_interval );
			}

			wp_safe_redirect( $redirect_to );
			exit;
		}

		login_header( __( 'Confirm your administration email' ), '', $errors );

		/**
		 * Fires before the admin email confirm form.
		 *
		 * @since 5.3.0
		 *
		 * @param WP_Error $errors A `WP_Error` object containing any errors generated by using invalid
		 *                         credentials. Note that the error object may not contain any errors.
		 */
		do_action( 'admin_email_confirm', $errors );

		?>

		<form class="admin-email-confirm-form" name="admin-email-confirm-form" action="<?php echo esc_url( site_url( 'wp-login.php?action=confirm_admin_email', 'login_post' ) ); ?>" method="post">
			<?php
			/**
			 * Fires inside the admin-email-confirm-form form tags, before the hidden fields.
			 *
			 * @since 5.3.0
			 */
			do_action( 'admin_email_confirm_form' );

			wp_nonce_field( 'confirm_admin_email', 'confirm_admin_email_nonce' );

			?>
			<input type="hidden" name="redirect_to" value="<?php echo esc_attr( $redirect_to ); ?>" />

			<h1 class="admin-email__heading">
				<?php _e( 'Administration email verification' ); ?>
			</h1>
			<p class="admin-email__details">
				<?php _e( 'Please verify that the <strong>administration email</strong> for this website is still correct.' ); ?>
				<?php

				/* translators: URL to the WordPress help section about admin email. */
				$admin_email_help_url = __( 'https://wordpress.org/documentation/article/settings-general-screen/#email-address' );

				$accessibility_text = sprintf(
					'<span class="screen-reader-text"> %s</span>',
					/* translators: Hidden accessibility text. */
					__( '(opens in a new tab)' )
				);

				printf(
					'<a href="%s" target="_blank">%s%s</a>',
					esc_url( $admin_email_help_url ),
					__( 'Why is this important?' ),
					$accessibility_text
				);

				?>
			</p>
			<p class="admin-email__details">
				<?php

				printf(
					/* translators: %s: Admin email address. */
					__( 'Current administration email: %s' ),
					'<strong>' . esc_html( $admin_email ) . '</strong>'
				);

				?>
			</p>
			<p class="admin-email__details">
				<?php _e( 'This email may be different from your personal email address.' ); ?>
			</p>

			<div class="admin-email__actions">
				<div class="admin-email__actions-primary">
					<?php

					$change_link = admin_url( 'options-general.php' );
					$change_link = add_query_arg( 'highlight', 'confirm_admin_email', $change_link );

					?>
					<a class="button button-large" href="<?php echo esc_url( $change_link ); ?>"><?php _e( 'Update' ); ?></a>
					<input type="submit" name="correct-admin-email" id="correct-admin-email" class="button button-primary button-large" value="<?php esc_attr_e( 'The email is correct' ); ?>" />
				</div>
				<?php if ( $remind_interval > 0 ) : ?>
					<div class="admin-email__actions-secondary">
						<?php

						$remind_me_link = wp_login_url( $redirect_to );
						$remind_me_link = add_query_arg(
							array(
								'action'          => 'confirm_admin_email',
								'remind_me_later' => wp_create_nonce( 'remind_me_later_nonce' ),
							),
							$remind_me_link
						);

						?>
						<a href="<?php echo esc_url( $remind_me_link ); ?>"><?php _e( 'Remind me later' ); ?></a>
					</div>
				<?php endif; ?>
			</div>
		</form>

		<?php

		login_footer();
		break;

	case 'postpass':
		$redirect_to = $_POST['redirect_to'] ?? wp_get_referer();

		if ( ! isset( $_POST['post_password'] ) || ! is_string( $_POST['post_password'] ) ) {
			wp_safe_redirect( $redirect_to );
			exit;
		}

		require_once ABSPATH . WPINC . '/class-phpass.php';
		$hasher = new PasswordHash( 8, true );

		/**
		 * Filters the life span of the post password cookie.
		 *
		 * By default, the cookie expires 10 days from creation. To turn this
		 * into a session cookie, return 0.
		 *
		 * @since 3.7.0
		 *
		 * @param int $expires The expiry time, as passed to setcookie().
		 */
		$expire = apply_filters( 'post_password_expires', time() + 10 * DAY_IN_SECONDS );

		if ( $redirect_to ) {
			$secure = ( 'https' === parse_url( $redirect_to, PHP_URL_SCHEME ) );
		} else {
			$secure = false;
		}

		setcookie( 'wp-postpass_' . COOKIEHASH, $hasher->HashPassword( wp_unslash( $_POST['post_password'] ) ), $expire, COOKIEPATH, COOKIE_DOMAIN, $secure );

		wp_safe_redirect( $redirect_to );
		exit;

	case 'logout':
		check_admin_referer( 'log-out' );

		$user = wp_get_current_user();

		wp_logout();

		if ( ! empty( $_REQUEST['redirect_to'] ) && is_string( $_REQUEST['redirect_to'] ) ) {
			$redirect_to           = $_REQUEST['redirect_to'];
			$requested_redirect_to = $redirect_to;
		} else {
			$redirect_to = add_query_arg(
				array(
					'loggedout' => 'true',
					'wp_lang'   => get_user_locale( $user ),
				),
				wp_login_url()
			);

			$requested_redirect_to = '';
		}

		/**
		 * Filters the log out redirect URL.
		 *
		 * @since 4.2.0
		 *
		 * @param string  $redirect_to           The redirect destination URL.
		 * @param string  $requested_redirect_to The requested redirect destination URL passed as a parameter.
		 * @param WP_User $user                  The WP_User object for the user that's logging out.
		 */
		$redirect_to = apply_filters( 'logout_redirect', $redirect_to, $requested_redirect_to, $user );

		wp_safe_redirect( $redirect_to );
		exit;

	case 'lostpassword':
	case 'retrievepassword':
		if ( $http_post ) {
			$errors = retrieve_password();

			if ( ! is_wp_error( $errors ) ) {
				$redirect_to = ! empty( $_REQUEST['redirect_to'] ) ? $_REQUEST['redirect_to'] : 'wp-login.php?checkemail=confirm';
				wp_safe_redirect( $redirect_to );
				exit;
			}
		}

		if ( isset( $_GET['error'] ) ) {
			if ( 'invalidkey' === $_GET['error'] ) {
				$errors->add( 'invalidkey', __( '<strong>Error:</strong> Your password reset link appears to be invalid. Please request a new link below.' ) );
			} elseif ( 'expiredkey' === $_GET['error'] ) {
				$errors->add( 'expiredkey', __( '<strong>Error:</strong> Your password reset link has expired. Please request a new link below.' ) );
			}
		}

		$lostpassword_redirect = ! empty( $_REQUEST['redirect_to'] ) ? $_REQUEST['redirect_to'] : '';
		/**
		 * Filters the URL redirected to after submitting the lostpassword/retrievepassword form.
		 *
		 * @since 3.0.0
		 *
		 * @param string $lostpassword_redirect The redirect destination URL.
		 */
		$redirect_to = apply_filters( 'lostpassword_redirect', $lostpassword_redirect );

		/**
		 * Fires before the lost password form.
		 *
		 * @since 1.5.1
		 * @since 5.1.0 Added the `$errors` parameter.
		 *
		 * @param WP_Error $errors A `WP_Error` object containing any errors generated by using invalid
		 *                         credentials. Note that the error object may not contain any errors.
		 */
		do_action( 'lost_password', $errors );

		login_header(
			__( 'Lost Password' ),
			wp_get_admin_notice(
				__( 'Please enter your username or email address. You will receive an email message with instructions on how to reset your password.' ),
				array(
					'type'               => 'info',
					'additional_classes' => array( 'message' ),
				)
			),
			$errors
		);

		$user_login = '';

		if ( isset( $_POST['user_login'] ) && is_string( $_POST['user_login'] ) ) {
			$user_login = wp_unslash( $_POST['user_login'] );
		}

		?>

		<form name="lostpasswordform" id="lostpasswordform" action="<?php echo esc_url( network_site_url( 'wp-login.php?action=lostpassword', 'login_post' ) ); ?>" method="post">
			<p>
				<label for="user_login"><?php _e( 'Username or Email Address' ); ?></label>
				<input type="text" name="user_login" id="user_login" class="input" value="<?php echo esc_attr( $user_login ); ?>" size="20" autocapitalize="off" autocomplete="username" required="required" />
			</p>
			<?php

			/**
			 * Fires inside the lostpassword form tags, before the hidden fields.
			 *
			 * @since 2.1.0
			 */
			do_action( 'lostpassword_form' );

			?>
			<input type="hidden" name="redirect_to" value="<?php echo esc_attr( $redirect_to ); ?>" />
			<p class="submit">
				<input type="submit" name="wp-submit" id="wp-submit" class="button button-primary button-large" value="<?php esc_attr_e( 'Get New Password' ); ?>" />
			</p>
		</form>

		<p id="nav">
			<a class="wp-login-log-in" href="<?php echo esc_url( wp_login_url() ); ?>"><?php _e( 'Log in' ); ?></a>
			<?php

			if ( get_option( 'users_can_register' ) ) {
				$registration_url = sprintf( '<a class="wp-login-register" href="%s">%s</a>', esc_url( wp_registration_url() ), __( 'Register' ) );

				echo esc_html( $login_link_separator );

				/** This filter is documented in wp-includes/general-template.php */
				echo apply_filters( 'register', $registration_url );
			}

			?>
		</p>
		<?php

		login_footer( 'user_login' );
		break;

	case 'resetpass':
	case 'rp':
		list( $rp_path ) = explode( '?', wp_unslash( $_SERVER['REQUEST_URI'] ) );
		$rp_cookie       = 'wp-resetpass-' . COOKIEHASH;

		if ( isset( $_GET['key'] ) && isset( $_GET['login'] ) ) {
			$value = sprintf( '%s:%s', wp_unslash( $_GET['login'] ), wp_unslash( $_GET['key'] ) );
			setcookie( $rp_cookie, $value, 0, $rp_path, COOKIE_DOMAIN, is_ssl(), true );

			wp_safe_redirect( remove_query_arg( array( 'key', 'login' ) ) );
			exit;
		}

		if ( isset( $_COOKIE[ $rp_cookie ] ) && 0 < strpos( $_COOKIE[ $rp_cookie ], ':' ) ) {
			list( $rp_login, $rp_key ) = explode( ':', wp_unslash( $_COOKIE[ $rp_cookie ] ), 2 );

			$user = check_password_reset_key( $rp_key, $rp_login );

			if ( isset( $_POST['pass1'] ) && ! hash_equals( $rp_key, $_POST['rp_key'] ) ) {
				$user = false;
			}
		} else {
			$user = false;
		}

		if ( ! $user || is_wp_error( $user ) ) {
			setcookie( $rp_cookie, ' ', time() - YEAR_IN_SECONDS, $rp_path, COOKIE_DOMAIN, is_ssl(), true );

			if ( $user && $user->get_error_code() === 'expired_key' ) {
				wp_redirect( site_url( 'wp-login.php?action=lostpassword&error=expiredkey' ) );
			} else {
				wp_redirect( site_url( 'wp-login.php?action=lostpassword&error=invalidkey' ) );
			}

			exit;
		}

		$errors = new WP_Error();

		// Check if password is one or all empty spaces.
		if ( ! empty( $_POST['pass1'] ) ) {
			$_POST['pass1'] = trim( $_POST['pass1'] );

			if ( empty( $_POST['pass1'] ) ) {
				$errors->add( 'password_reset_empty_space', __( 'The password cannot be a space or all spaces.' ) );
			}
		}

		// Check if password fields do not match.
		if ( ! empty( $_POST['pass1'] ) && trim( $_POST['pass2'] ) !== $_POST['pass1'] ) {
			$errors->add( 'password_reset_mismatch', __( '<strong>Error:</strong> The passwords do not match.' ) );
		}

		/**
		 * Fires before the password reset procedure is validated.
		 *
		 * @since 3.5.0
		 *
		 * @param WP_Error         $errors WP Error object.
		 * @param WP_User|WP_Error $user   WP_User object if the login and reset key match. WP_Error object otherwise.
		 */
		do_action( 'validate_password_reset', $errors, $user );

		if ( ( ! $errors->has_errors() ) && isset( $_POST['pass1'] ) && ! empty( $_POST['pass1'] ) ) {
			reset_password( $user, $_POST['pass1'] );
			setcookie( $rp_cookie, ' ', time() - YEAR_IN_SECONDS, $rp_path, COOKIE_DOMAIN, is_ssl(), true );
			login_header(
				__( 'Password Reset' ),
				wp_get_admin_notice(
					__( 'Your password has been reset.' ) . ' <a href="' . esc_url( wp_login_url() ) . '">' . __( 'Log in' ) . '</a>',
					array(
						'type'               => 'info',
						'additional_classes' => array( 'message', 'reset-pass' ),
					)
				)
			);
			login_footer();
			exit;
		}

		wp_enqueue_script( 'utils' );
		wp_enqueue_script( 'user-profile' );

		login_header(
			__( 'Reset Password' ),
			wp_get_admin_notice(
				__( 'Enter your new password below or generate one.' ),
				array(
					'type'               => 'info',
					'additional_classes' => array( 'message', 'reset-pass' ),
				)
			),
			$errors
		);

		?>
		<form name="resetpassform" id="resetpassform" action="<?php echo esc_url( network_site_url( 'wp-login.php?action=resetpass', 'login_post' ) ); ?>" method="post" autocomplete="off">
			<input type="hidden" id="user_login" value="<?php echo esc_attr( $rp_login ); ?>" autocomplete="off" />

			<div class="user-pass1-wrap">
				<p>
					<label for="pass1"><?php _e( 'New password' ); ?></label>
				</p>

				<div class="wp-pwd">
					<input type="password" name="pass1" id="pass1" class="input password-input" size="24" value="" autocomplete="new-password" spellcheck="false" data-reveal="1" data-pw="<?php echo esc_attr( wp_generate_password( 16 ) ); ?>" aria-describedby="pass-strength-result" />

					<button type="button" class="button button-secondary wp-hide-pw hide-if-no-js" data-toggle="0" aria-label="<?php esc_attr_e( 'Hide password' ); ?>">
						<span class="dashicons dashicons-hidden" aria-hidden="true"></span>
					</button>
					<div id="pass-strength-result" class="hide-if-no-js" aria-live="polite"><?php _e( 'Strength indicator' ); ?></div>
				</div>
				<div class="pw-weak">
					<input type="checkbox" name="pw_weak" id="pw-weak" class="pw-checkbox" />
					<label for="pw-weak"><?php _e( 'Confirm use of weak password' ); ?></label>
				</div>
			</div>

			<p class="user-pass2-wrap">
				<label for="pass2"><?php _e( 'Confirm new password' ); ?></label>
				<input type="password" name="pass2" id="pass2" class="input" size="20" value="" autocomplete="new-password" spellcheck="false" />
			</p>

			<p class="description indicator-hint"><?php echo wp_get_password_hint(); ?></p>

			<?php

			/**
			 * Fires following the 'Strength indicator' meter in the user password reset form.
			 *
			 * @since 3.9.0
			 *
			 * @param WP_User $user User object of the user whose password is being reset.
			 */
			do_action( 'resetpass_form', $user );

			?>
			<input type="hidden" name="rp_key" value="<?php echo esc_attr( $rp_key ); ?>" />
			<p class="submit reset-pass-submit">
				<button type="button" class="button wp-generate-pw hide-if-no-js skip-aria-expanded"><?php _e( 'Generate Password' ); ?></button>
				<input type="submit" name="wp-submit" id="wp-submit" class="button button-primary button-large" value="<?php esc_attr_e( 'Save Password' ); ?>" />
			</p>
		</form>

		<p id="nav">
			<a class="wp-login-log-in" href="<?php echo esc_url( wp_login_url() ); ?>"><?php _e( 'Log in' ); ?></a>
			<?php

			if ( get_option( 'users_can_register' ) ) {
				$registration_url = sprintf( '<a class="wp-login-register" href="%s">%s</a>', esc_url( wp_registration_url() ), __( 'Register' ) );

				echo esc_html( $login_link_separator );

				/** This filter is documented in wp-includes/general-template.php */
				echo apply_filters( 'register', $registration_url );
			}

			?>
		</p>
		<?php

		login_footer( 'pass1' );
		break;

	case 'register':
		if ( is_multisite() ) {
			/**
			 * Filters the Multisite sign up URL.
			 *
			 * @since 3.0.0
			 *
			 * @param string $sign_up_url The sign up URL.
			 */
			wp_redirect( apply_filters( 'wp_signup_location', network_site_url( 'wp-signup.php' ) ) );
			exit;
		}

		if ( ! get_option( 'users_can_register' ) ) {
			wp_redirect( site_url( 'wp-login.php?registration=disabled' ) );
			exit;
		}

		$user_login = '';
		$user_email = '';

		if ( $http_post ) {
			if ( isset( $_POST['user_login'] ) && is_string( $_POST['user_login'] ) ) {
				$user_login = wp_unslash( $_POST['user_login'] );
			}

			if ( isset( $_POST['user_email'] ) && is_string( $_POST['user_email'] ) ) {
				$user_email = wp_unslash( $_POST['user_email'] );
			}

			$errors = register_new_user( $user_login, $user_email );

			if ( ! is_wp_error( $errors ) ) {
				$redirect_to = ! empty( $_POST['redirect_to'] ) ? $_POST['redirect_to'] : 'wp-login.php?checkemail=registered';
				wp_safe_redirect( $redirect_to );
				exit;
			}
		}

		$registration_redirect = ! empty( $_REQUEST['redirect_to'] ) ? $_REQUEST['redirect_to'] : '';

		/**
		 * Filters the registration redirect URL.
		 *
		 * @since 3.0.0
		 * @since 5.9.0 Added the `$errors` parameter.
		 *
		 * @param string       $registration_redirect The redirect destination URL.
		 * @param int|WP_Error $errors                User id if registration was successful,
		 *                                            WP_Error object otherwise.
		 */
		$redirect_to = apply_filters( 'registration_redirect', $registration_redirect, $errors );

		login_header(
			__( 'Registration Form' ),
			wp_get_admin_notice(
				__( 'Register For This Site' ),
				array(
					'type'               => 'info',
					'additional_classes' => array( 'message', 'register' ),
				)
			),
			$errors
		);

		?>
		<form name="registerform" id="registerform" action="<?php echo esc_url( site_url( 'wp-login.php?action=register', 'login_post' ) ); ?>" method="post" novalidate="novalidate">
			<p>
				<label for="user_login"><?php _e( 'Username' ); ?></label>
				<input type="text" name="user_login" id="user_login" class="input" value="<?php echo esc_attr( $user_login ); ?>" size="20" autocapitalize="off" autocomplete="username" required="required" />
			</p>
			<p>
				<label for="user_email"><?php _e( 'Email' ); ?></label>
				<input type="email" name="user_email" id="user_email" class="input" value="<?php echo esc_attr( $user_email ); ?>" size="25" autocomplete="email" required="required" />
			</p>
			<?php

			/**
			 * Fires following the 'Email' field in the user registration form.
			 *
			 * @since 2.1.0
			 */
			do_action( 'register_form' );

			?>
			<p id="reg_passmail">
				<?php _e( 'Registration confirmation will be emailed to you.' ); ?>
			</p>
			<input type="hidden" name="redirect_to" value="<?php echo esc_attr( $redirect_to ); ?>" />
			<p class="submit">
				<input type="submit" name="wp-submit" id="wp-submit" class="button button-primary button-large" value="<?php esc_attr_e( 'Register' ); ?>" />
			</p>
		</form>

		<p id="nav">
			<a class="wp-login-log-in" href="<?php echo esc_url( wp_login_url() ); ?>"><?php _e( 'Log in' ); ?></a>
			<?php

			echo esc_html( $login_link_separator );

			$html_link = sprintf( '<a class="wp-login-lost-password" href="%s">%s</a>', esc_url( wp_lostpassword_url() ), __( 'Lost your password?' ) );

			/** This filter is documented in wp-login.php */
			echo apply_filters( 'lost_password_html_link', $html_link );

			?>
		</p>
		<?php

		login_footer( 'user_login' );
		break;

	case 'checkemail':
		$redirect_to = admin_url();
		$errors      = new WP_Error();

		if ( 'confirm' === $_GET['checkemail'] ) {
			$errors->add(
				'confirm',
				sprintf(
					/* translators: %s: Link to the login page. */
					__( 'Check your email for the confirmation link, then visit the <a href="%s">login page</a>.' ),
					wp_login_url()
				),
				'message'
			);
		} elseif ( 'registered' === $_GET['checkemail'] ) {
			$errors->add(
				'registered',
				sprintf(
					/* translators: %s: Link to the login page. */
					__( 'Registration complete. Please check your email, then visit the <a href="%s">login page</a>.' ),
					wp_login_url()
				),
				'message'
			);
		}

		/** This action is documented in wp-login.php */
		$errors = apply_filters( 'wp_login_errors', $errors, $redirect_to );

		login_header( __( 'Check your email' ), '', $errors );
		login_footer();
		break;

	case 'confirmaction':
		if ( ! isset( $_GET['request_id'] ) ) {
			wp_die( __( 'Missing request ID.' ) );
		}

		if ( ! isset( $_GET['confirm_key'] ) ) {
			wp_die( __( 'Missing confirm key.' ) );
		}

		$request_id = (int) $_GET['request_id'];
		$key        = sanitize_text_field( wp_unslash( $_GET['confirm_key'] ) );
		$result     = wp_validate_user_request_key( $request_id, $key );

		if ( is_wp_error( $result ) ) {
			wp_die( $result );
		}

		/**
		 * Fires an action hook when the account action has been confirmed by the user.
		 *
		 * Using this you can assume the user has agreed to perform the action by
		 * clicking on the link in the confirmation email.
		 *
		 * After firing this action hook the page will redirect to wp-login a callback
		 * redirects or exits first.
		 *
		 * @since 4.9.6
		 *
		 * @param int $request_id Request ID.
		 */
		do_action( 'user_request_action_confirmed', $request_id );

		$message = _wp_privacy_account_request_confirmed_message( $request_id );

		login_header( __( 'User action confirmed.' ), $message );
		login_footer();
		exit;

	case 'login':
	default:
		$secure_cookie   = '';
		$customize_login = isset( $_REQUEST['customize-login'] );

		if ( $customize_login ) {
			wp_enqueue_script( 'customize-base' );
		}

		// If the user wants SSL but the session is not SSL, force a secure cookie.
		if ( ! empty( $_POST['log'] ) && ! force_ssl_admin() ) {
			$user_name = sanitize_user( wp_unslash( $_POST['log'] ) );
			$user      = get_user_by( 'login', $user_name );

			if ( ! $user && strpos( $user_name, '@' ) ) {
				$user = get_user_by( 'email', $user_name );
			}

			if ( $user ) {
				if ( get_user_option( 'use_ssl', $user->ID ) ) {
					$secure_cookie = true;
					force_ssl_admin( true );
				}
			}
		}

		if ( isset( $_REQUEST['redirect_to'] ) && is_string( $_REQUEST['redirect_to'] ) ) {
			$redirect_to = $_REQUEST['redirect_to'];
			// Redirect to HTTPS if user wants SSL.
			if ( $secure_cookie && str_contains( $redirect_to, 'wp-admin' ) ) {
				$redirect_to = preg_replace( '|^http://|', 'https://', $redirect_to );
			}
		} else {
			$redirect_to = admin_url();
		}

		$reauth = ! empty( $_REQUEST['reauth'] );

		$user = wp_signon( array(), $secure_cookie );

		if ( empty( $_COOKIE[ LOGGED_IN_COOKIE ] ) ) {
			if ( headers_sent() ) {
				$user = new WP_Error(
					'test_cookie',
					sprintf(
						/* translators: 1: Browser cookie documentation URL, 2: Support forums URL. */
						__( '<strong>Error:</strong> Cookies are blocked due to unexpected output. For help, please see <a href="%1$s">this documentation</a> or try the <a href="%2$s">support forums</a>.' ),
						__( 'https://developer.wordpress.org/advanced-administration/wordpress/cookies/' ),
						__( 'https://wordpress.org/support/forums/' )
					)
				);
			} elseif ( isset( $_POST['testcookie'] ) && empty( $_COOKIE[ TEST_COOKIE ] ) ) {
				// If cookies are disabled, the user can't log in even with a valid username and password.
				$user = new WP_Error(
					'test_cookie',
					sprintf(
						/* translators: %s: Browser cookie documentation URL. */
						__( '<strong>Error:</strong> Cookies are blocked or not supported by your browser. You must <a href="%s">enable cookies</a> to use WordPress.' ),
						__( 'https://developer.wordpress.org/advanced-administration/wordpress/cookies/#enable-cookies-in-your-browser' )
					)
				);
			}
		}

		$requested_redirect_to = isset( $_REQUEST['redirect_to'] ) && is_string( $_REQUEST['redirect_to'] ) ? $_REQUEST['redirect_to'] : '';

		/**
		 * Filters the login redirect URL.
		 *
		 * @since 3.0.0
		 *
		 * @param string           $redirect_to           The redirect destination URL.
		 * @param string           $requested_redirect_to The requested redirect destination URL passed as a parameter.
		 * @param WP_User|WP_Error $user                  WP_User object if login was successful, WP_Error object otherwise.
		 */
		$redirect_to = apply_filters( 'login_redirect', $redirect_to, $requested_redirect_to, $user );

		if ( ! is_wp_error( $user ) && ! $reauth ) {
			if ( $interim_login ) {
				$message       = '<p class="message">' . __( 'You have logged in successfully.' ) . '</p>';
				$interim_login = 'success';
				login_header( '', $message );

				?>
				</div>
				<?php

				/** This action is documented in wp-login.php */
				do_action( 'login_footer' );

				if ( $customize_login ) {
					ob_start();
					?>
					<script>setTimeout( function(){ new wp.customize.Messenger({ url: '<?php echo wp_customize_url(); ?>', channel: 'login' }).send('login') }, 1000 );</script>
					<?php
					wp_print_inline_script_tag( wp_remove_surrounding_empty_script_tags( ob_get_clean() ) );
				}

				?>
				</body></html>
				<?php

				exit;
			}

			// Check if it is time to add a redirect to the admin email confirmation screen.
			if ( $user instanceof WP_User && $user->exists() && $user->has_cap( 'manage_options' ) ) {
				$admin_email_lifespan = (int) get_option( 'admin_email_lifespan' );

				/*
				 * If `0` (or anything "falsey" as it is cast to int) is returned, the user will not be redirected
				 * to the admin email confirmation screen.
				 */
				/** This filter is documented in wp-login.php */
				$admin_email_check_interval = (int) apply_filters( 'admin_email_check_interval', 6 * MONTH_IN_SECONDS );

				if ( $admin_email_check_interval > 0 && time() > $admin_email_lifespan ) {
					$redirect_to = add_query_arg(
						array(
							'action'  => 'confirm_admin_email',
							'wp_lang' => get_user_locale( $user ),
						),
						wp_login_url( $redirect_to )
					);
				}
			}

			if ( ( empty( $redirect_to ) || 'wp-admin/' === $redirect_to || admin_url() === $redirect_to ) ) {
				// If the user doesn't belong to a blog, send them to user admin. If the user can't edit posts, send them to their profile.
				if ( is_multisite() && ! get_active_blog_for_user( $user->ID ) && ! is_super_admin( $user->ID ) ) {
					$redirect_to = user_admin_url();
				} elseif ( is_multisite() && ! $user->has_cap( 'read' ) ) {
					$redirect_to = get_dashboard_url( $user->ID );
				} elseif ( ! $user->has_cap( 'edit_posts' ) ) {
					$redirect_to = $user->has_cap( 'read' ) ? admin_url( 'profile.php' ) : home_url();
				}

				wp_redirect( $redirect_to );
				exit;
			}

			wp_safe_redirect( $redirect_to );
			exit;
		}

		$errors = $user;
		// Clear errors if loggedout is set.
		if ( ! empty( $_GET['loggedout'] ) || $reauth ) {
			$errors = new WP_Error();
		}

		if ( empty( $_POST ) && $errors->get_error_codes() === array( 'empty_username', 'empty_password' ) ) {
			$errors = new WP_Error( '', '' );
		}

		if ( $interim_login ) {
			if ( ! $errors->has_errors() ) {
				$errors->add( 'expired', __( 'Your session has expired. Please log in to continue where you left off.' ), 'message' );
			}
		} else {
			// Some parts of this script use the main login form to display a message.
			if ( isset( $_GET['loggedout'] ) && $_GET['loggedout'] ) {
				$errors->add( 'loggedout', __( 'You are now logged out.' ), 'message' );
			} elseif ( isset( $_GET['registration'] ) && 'disabled' === $_GET['registration'] ) {
				$errors->add( 'registerdisabled', __( '<strong>Error:</strong> User registration is currently not allowed.' ) );
			} elseif ( str_contains( $redirect_to, 'about.php?updated' ) ) {
				$errors->add( 'updated', __( '<strong>You have successfully updated WordPress!</strong> Please log back in to see what&#8217;s new.' ), 'message' );
			} elseif ( WP_Recovery_Mode_Link_Service::LOGIN_ACTION_ENTERED === $action ) {
				$errors->add( 'enter_recovery_mode', __( 'Recovery Mode Initialized. Please log in to continue.' ), 'message' );
			} elseif ( isset( $_GET['redirect_to'] ) && is_string( $_GET['redirect_to'] )
				&& str_contains( $_GET['redirect_to'], 'wp-admin/authorize-application.php' )
			) {
				$query_component = wp_parse_url( $_GET['redirect_to'], PHP_URL_QUERY );
				$query           = array();
				if ( $query_component ) {
					parse_str( $query_component, $query );
				}

				if ( ! empty( $query['app_name'] ) ) {
					/* translators: 1: Website name, 2: Application name. */
					$message = sprintf( 'Please log in to %1$s to authorize %2$s to connect to your account.', get_bloginfo( 'name', 'display' ), '<strong>' . esc_html( $query['app_name'] ) . '</strong>' );
				} else {
					/* translators: %s: Website name. */
					$message = sprintf( 'Please log in to %s to proceed with authorization.', get_bloginfo( 'name', 'display' ) );
				}

				$errors->add( 'authorize_application', $message, 'message' );
			}
		}

		/**
		 * Filters the login page errors.
		 *
		 * @since 3.6.0
		 *
		 * @param WP_Error $errors      WP Error object.
		 * @param string   $redirect_to Redirect destination URL.
		 */
		$errors = apply_filters( 'wp_login_errors', $errors, $redirect_to );

		// Clear any stale cookies.
		if ( $reauth ) {
			wp_clear_auth_cookie();
		}

		login_header( __( 'Log In' ), '', $errors );

		if ( isset( $_POST['log'] ) ) {
			$user_login = ( 'incorrect_password' === $errors->get_error_code() || 'empty_password' === $errors->get_error_code() ) ? wp_unslash( $_POST['log'] ) : '';
		}

		$rememberme = ! empty( $_POST['rememberme'] );

		$aria_describedby = '';
		$has_errors       = $errors->has_errors();

		if ( $has_errors ) {
			$aria_describedby = ' aria-describedby="login_error"';
		}

		if ( $has_errors && 'message' === $errors->get_error_data() ) {
			$aria_describedby = ' aria-describedby="login-message"';
		}

		wp_enqueue_script( 'user-profile' );
		?>

		<form name="loginform" id="loginform" action="<?php echo esc_url( site_url( 'wp-login.php', 'login_post' ) ); ?>" method="post">
			<p>
				<label for="user_login"><?php _e( 'Username or Email Address' ); ?></label>
				<input type="text" name="log" id="user_login"<?php echo $aria_describedby; ?> class="input" value="<?php echo esc_attr( $user_login ); ?>" size="20" autocapitalize="off" autocomplete="username" required="required" />
			</p>

			<div class="user-pass-wrap">
				<label for="user_pass"><?php _e( 'Password' ); ?></label>
				<div class="wp-pwd">
					<input type="password" name="pwd" id="user_pass"<?php echo $aria_describedby; ?> class="input password-input" value="" size="20" autocomplete="current-password" spellcheck="false" required="required" />
					<button type="button" class="button button-secondary wp-hide-pw hide-if-no-js" data-toggle="0" aria-label="<?php esc_attr_e( 'Show password' ); ?>">
						<span class="dashicons dashicons-visibility" aria-hidden="true"></span>
					</button>
				</div>
			</div>
			<?php

			/**
			 * Fires following the 'Password' field in the login form.
			 *
			 * @since 2.1.0
			 */
			do_action( 'login_form' );

			?>
			<p class="forgetmenot"><input name="rememberme" type="checkbox" id="rememberme" value="forever" <?php checked( $rememberme ); ?> /> <label for="rememberme"><?php esc_html_e( 'Remember Me' ); ?></label></p>
			<p class="submit">
				<input type="submit" name="wp-submit" id="wp-submit" class="button button-primary button-large" value="<?php esc_attr_e( 'Log In' ); ?>" />
				<?php

				if ( $interim_login ) {
					?>
					<input type="hidden" name="interim-login" value="1" />
					<?php
				} else {
					?>
					<input type="hidden" name="redirect_to" value="<?php echo esc_attr( $redirect_to ); ?>" />
					<?php
				}

				if ( $customize_login ) {
					?>
					<input type="hidden" name="customize-login" value="1" />
					<?php
				}

				?>
				<input type="hidden" name="testcookie" value="1" />
			</p>
		</form>

		<?php

		if ( ! $interim_login ) {
			?>
			<p id="nav">
				<?php

				if ( get_option( 'users_can_register' ) ) {
					$registration_url = sprintf( '<a class="wp-login-register" href="%s">%s</a>', esc_url( wp_registration_url() ), __( 'Register' ) );

					/** This filter is documented in wp-includes/general-template.php */
					echo apply_filters( 'register', $registration_url );

					echo esc_html( $login_link_separator );
				}

				$html_link = sprintf( '<a class="wp-login-lost-password" href="%s">%s</a>', esc_url( wp_lostpassword_url() ), __( 'Lost your password?' ) );

				/**
				 * Filters the link that allows the user to reset the lost password.
				 *
				 * @since 6.1.0
				 *
				 * @param string $html_link HTML link to the lost password form.
				 */
				echo apply_filters( 'lost_password_html_link', $html_link );

				?>
			</p>
			<?php
		}

		$login_script  = 'function wp_attempt_focus() {';
		$login_script .= 'setTimeout( function() {';
		$login_script .= 'try {';

		if ( $user_login ) {
			$login_script .= 'd = document.getElementById( "user_pass" ); d.value = "";';
		} else {
			$login_script .= 'd = document.getElementById( "user_login" );';

			if ( $errors->get_error_code() === 'invalid_username' ) {
				$login_script .= 'd.value = "";';
			}
		}

		$login_script .= 'd.focus(); d.select();';
		$login_script .= '} catch( er ) {}';
		$login_script .= '}, 200);';
		$login_script .= "}\n"; // End of wp_attempt_focus().

		/**
		 * Filters whether to print the call to `wp_attempt_focus()` on the login screen.
		 *
		 * @since 4.8.0
		 *
		 * @param bool $print Whether to print the function call. Default true.
		 */
		if ( apply_filters( 'enable_login_autofocus', true ) && ! $error ) {
			$login_script .= "wp_attempt_focus();\n";
		}

		// Run `wpOnload()` if defined.
		$login_script .= "if ( typeof wpOnload === 'function' ) { wpOnload() }";

		wp_print_inline_script_tag( $login_script );

		if ( $interim_login ) {
			ob_start();
			?>
			<script>
			( function() {
				try {
					var i, links = document.getElementsByTagName( 'a' );
					for ( i in links ) {
						if ( links[i].href ) {
							links[i].target = '_blank';
						}
					}
				} catch( er ) {}
			}());
			</script>
			<?php
			wp_print_inline_script_tag( wp_remove_surrounding_empty_script_tags( ob_get_clean() ) );
		}

		login_footer();
		break;
} // End action switch.



<?php
/**
 * Plugin Name: LatePoint
 * Description: Appointment Scheduling Software for WordPress
 * Version: 5.2.4
 * Author: LatePoint
 * Author URI: https://latepoint.com
 * Plugin URI: https://latepoint.com
 * Text Domain: latepoint
 * Domain Path: /languages
 * License: GPLv3
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit; // Exit if accessed directly.
}


if ( ! class_exists( 'LatePoint' ) ) :

	/**
	 * Main LatePoint Class.
	 *
	 */

	final class LatePoint {

		/**
		 * LatePoint version.
		 *
		 */
		public $version = '5.2.4';
		public $db_version = '2.3.0';


		/**
		 * LatePoint Constructor.
		 */
		public function __construct() {

			$this->define_constants();
			$this->includes();
			$this->init_hooks();
			OsDatabaseHelper::check_db_version();
			OsDatabaseHelper::check_db_version_for_addons();


			$GLOBALS['latepoint_settings'] = new OsSettingsHelper();

		}


		/**
		 * Define constant if not already set.
		 *
		 */
		public function define( $name, $value ) {
			if ( ! defined( $name ) ) {
				define( $name, $value );
			}
		}


		/**
		 * Get the plugin url. *has trailing slash
		 * @return string
		 */
		public static function plugin_url() {
			return plugin_dir_url( __FILE__ );
		}

		public static function public_javascripts() {
			return plugin_dir_url( __FILE__ ) . 'public/javascripts/';
		}

		public static function public_vendor_javascripts() {
			return plugin_dir_url( __FILE__ ) . 'public/javascripts/vendor/';
		}

		public static function public_stylesheets() {
			return plugin_dir_url( __FILE__ ) . 'public/stylesheets/';
		}

		public static function blocks_build_url() {
			return plugin_dir_url( __FILE__ ) . 'blocks/build/';
		}

		public static function node_modules_url() {
			return plugin_dir_url( __FILE__ ) . 'node_modules/';
		}

		public static function vendor_assets_url() {
			return plugin_dir_url( __FILE__ ) . 'vendor/';
		}

		public static function images_url() {
			return plugin_dir_url( __FILE__ ) . 'public/images/';
		}

		/**
		 * Get the plugin path.
		 * @return string
		 */
		public static function plugin_path() {
			return plugin_dir_path( __FILE__ );
		}


		/**
		 * Define LatePoint Constants.
		 */
		public function define_constants() {
			$upload_dir = wp_upload_dir();

			// ENVIRONMENTS TYPES
			if ( ! defined( 'LATEPOINT_ENV_LIVE' ) ) {
				define( 'LATEPOINT_ENV_LIVE', 'live' );
			}
			if ( ! defined( 'LATEPOINT_ENV_DEMO' ) ) {
				define( 'LATEPOINT_ENV_DEMO', 'demo' );
			}
			if ( ! defined( 'LATEPOINT_ENV_DEV' ) ) {
				define( 'LATEPOINT_ENV_DEV', 'dev' );
			}

			// PAYMENT ENVIRONMENTS TYPES
			if ( ! defined( 'LATEPOINT_PAYMENTS_ENV_LIVE' ) ) {
				define( 'LATEPOINT_PAYMENTS_ENV_LIVE', 'live' );
			}
			if ( ! defined( 'LATEPOINT_PAYMENTS_ENV_DEMO' ) ) {
				define( 'LATEPOINT_PAYMENTS_ENV_DEMO', 'demo' );
			}
			if ( ! defined( 'LATEPOINT_PAYMENTS_ENV_DEV' ) ) {
				define( 'LATEPOINT_PAYMENTS_ENV_DEV', 'dev' );
			}


			if ( ! defined( 'LATEPOINT_PAYMENTS_DEV_SUFFIX' ) ) {
				define( 'LATEPOINT_PAYMENTS_DEV_SUFFIX', '_dev' );
			}

			if ( ! defined( 'LATEPOINT_ENV' ) ) {
				define( 'LATEPOINT_ENV', LATEPOINT_ENV_LIVE );
			}
			if ( ! defined( 'LATEPOINT_ALLOW_LOCAL_SERVER' ) ) {
				define( 'LATEPOINT_ALLOW_LOCAL_SERVER', true );
			}

			if ( ! defined( 'LATEPOINT_ALLOW_SMS' ) ) {
				define( 'LATEPOINT_ALLOW_SMS', true );
			}
			if ( ! defined( 'LATEPOINT_ALLOW_WHATSAPP' ) ) {
				define( 'LATEPOINT_ALLOW_WHATSAPP', true );
			}
			if ( ! defined( 'LATEPOINT_ALLOW_EMAILS' ) ) {
				define( 'LATEPOINT_ALLOW_EMAILS', true );
			}

			if ( ! defined( 'LATEPOINT_PLUGIN_FILE' ) ) {
				define( 'LATEPOINT_PLUGIN_FILE', __FILE__ );
			}
			if ( ! defined( 'LATEPOINT_STYLESHEETS_URL' ) ) {
				define( 'LATEPOINT_STYLESHEETS_URL', $this->public_stylesheets() );
			}
			if ( ! defined( 'LATEPOINT_BLOCKS_BUILD_URL' ) ) {
				define( 'LATEPOINT_BLOCKS_BUILD_URL', $this->blocks_build_url() );
			}
			if ( ! defined( 'LATEPOINT_ABSPATH' ) ) {
				define( 'LATEPOINT_ABSPATH', dirname( __FILE__ ) . '/' );
			}
			if ( ! defined( 'LATEPOINT_LIB_ABSPATH' ) ) {
				define( 'LATEPOINT_LIB_ABSPATH', LATEPOINT_ABSPATH . 'lib/' );
			}
			if ( ! defined( 'LATEPOINT_CONFIG_ABSPATH' ) ) {
				define( 'LATEPOINT_CONFIG_ABSPATH', LATEPOINT_LIB_ABSPATH . 'config/' );
			}
			if ( ! defined( 'LATEPOINT_BLOCKS_ABSPATH' ) ) {
				define( 'LATEPOINT_BLOCKS_ABSPATH', LATEPOINT_ABSPATH . 'blocks/build/' );
			}
			if ( ! defined( 'LATEPOINT_BOWER_ABSPATH' ) ) {
				define( 'LATEPOINT_BOWER_ABSPATH', LATEPOINT_ABSPATH . 'vendor/bower_components/' );
			}
			if ( ! defined( 'LATEPOINT_VIEWS_ABSPATH' ) ) {
				define( 'LATEPOINT_VIEWS_ABSPATH', LATEPOINT_LIB_ABSPATH . 'views/' );
			}
			if ( ! defined( 'LATEPOINT_VIEWS_ABSPATH_SHARED' ) ) {
				define( 'LATEPOINT_VIEWS_ABSPATH_SHARED', LATEPOINT_LIB_ABSPATH . 'views/shared/' );
			}
			if ( ! defined( 'LATEPOINT_VIEWS_MAILERS_ABSPATH' ) ) {
				define( 'LATEPOINT_VIEWS_MAILERS_ABSPATH', LATEPOINT_VIEWS_ABSPATH . 'mailers/' );
			}
			if ( ! defined( 'LATEPOINT_VIEWS_LAYOUTS_ABSPATH' ) ) {
				define( 'LATEPOINT_VIEWS_LAYOUTS_ABSPATH', LATEPOINT_VIEWS_ABSPATH . 'layouts/' );
			}
			if ( ! defined( 'LATEPOINT_VIEWS_PARTIALS_ABSPATH' ) ) {
				define( 'LATEPOINT_VIEWS_PARTIALS_ABSPATH', LATEPOINT_VIEWS_ABSPATH . 'partials/' );
			}
			if ( ! defined( 'LATEPOINT_PLUGIN_BASENAME' ) ) {
				define( 'LATEPOINT_PLUGIN_BASENAME', plugin_basename( __FILE__ ) );
			}

			if ( ! defined( 'LATEPOINT_PLUGIN_URL' ) ) {
				define( 'LATEPOINT_PLUGIN_URL', $this->plugin_url() );
			}
			if ( ! defined( 'LATEPOINT_LIB_URL' ) ) {
				define( 'LATEPOINT_LIB_URL', LATEPOINT_PLUGIN_URL . 'lib/' );
			}
			if ( ! defined( 'LATEPOINT_PUBLIC_URL' ) ) {
				define( 'LATEPOINT_PUBLIC_URL', LATEPOINT_PLUGIN_URL . 'public/' );
			}
			if ( ! defined( 'LATEPOINT_IMAGES_URL' ) ) {
				define( 'LATEPOINT_IMAGES_URL', LATEPOINT_PUBLIC_URL . 'images/' );
			}
			if ( ! defined( 'LATEPOINT_DEFAULT_AVATAR_URL' ) ) {
				define( 'LATEPOINT_DEFAULT_AVATAR_URL', LATEPOINT_IMAGES_URL . 'default-avatar.jpg' );
			}
			if ( ! defined( 'LATEPOINT_MARKETPLACE' ) ) {
				define( 'LATEPOINT_MARKETPLACE', 'codecanyon' );
			}
			// role to assigne WP user to so they are connected to a LatePoint backend user type (agent or manager)
			if ( ! defined( 'LATEPOINT_WP_ADMIN_ROLE' ) ) {
				define( 'LATEPOINT_WP_ADMIN_ROLE', 'administrator' );
			}
			if ( ! defined( 'LATEPOINT_WP_AGENT_ROLE' ) ) {
				define( 'LATEPOINT_WP_AGENT_ROLE', 'latepoint_agent' );
			}
			if ( ! defined( 'LATEPOINT_WP_MANAGER_ROLE' ) ) {
				define( 'LATEPOINT_WP_MANAGER_ROLE', 'latepoint_manager' );
			}
			if ( ! defined( 'LATEPOINT_WP_CUSTOMER_ROLE' ) ) {
				define( 'LATEPOINT_WP_CUSTOMER_ROLE', 'latepoint_customer' );
			}

			if ( ! defined( 'LATEPOINT_USER_TYPE_ADMIN' ) ) {
				define( 'LATEPOINT_USER_TYPE_ADMIN', 'admin' );
			}
			if ( ! defined( 'LATEPOINT_USER_TYPE_AGENT' ) ) {
				define( 'LATEPOINT_USER_TYPE_AGENT', 'agent' );
			}
			if ( ! defined( 'LATEPOINT_USER_TYPE_CUSTOM' ) ) {
				define( 'LATEPOINT_USER_TYPE_CUSTOM', 'custom' );
			}
			if ( ! defined( 'LATEPOINT_USER_TYPE_CUSTOMER' ) ) {
				define( 'LATEPOINT_USER_TYPE_CUSTOMER', 'customer' );
			}

			if ( ! defined( 'LATEPOINT_PARAMS_SCOPE_PUBLIC' ) ) {
				define( 'LATEPOINT_PARAMS_SCOPE_PUBLIC', 'public' );
			}
			if ( ! defined( 'LATEPOINT_PARAMS_SCOPE_ADMIN' ) ) {
				define( 'LATEPOINT_PARAMS_SCOPE_ADMIN', 'admin' );
			}
			if ( ! defined( 'LATEPOINT_PARAMS_SCOPE_CUSTOMER' ) ) {
				define( 'LATEPOINT_PARAMS_SCOPE_CUSTOMER', 'customer' );
			}


			if ( ! defined( 'LATEPOINT_VERSION' ) ) {
				define( 'LATEPOINT_VERSION', $this->version );
			}
			if ( ! defined( 'LATEPOINT_ENCRYPTION_KEY' ) ) {
				define( 'LATEPOINT_ENCRYPTION_KEY', 'oiaf(*Ufdsoh2ie7QEy,R@6(I9H/VoX^r4}SHC_7W-<$S!,/kd)OSw?.Y9lcd105cu$' );
			}

			if ( ! defined( 'LATEPOINT_AGENT_POST_TYPE' ) ) {
				define( 'LATEPOINT_AGENT_POST_TYPE', 'latepoint_agent' );
			}

			if ( ! defined( 'LATEPOINT_UPGRADE_URL' ) ) {
				define( 'LATEPOINT_UPGRADE_URL', 'https://latepoint.com/upgrade-from-wp' );
			}
			if ( ! defined( 'LATEPOINT_SERVICE_POST_TYPE' ) ) {
				define( 'LATEPOINT_SERVICE_POST_TYPE', 'latepoint_service' );
			}
			if ( ! defined( 'LATEPOINT_CUSTOMER_POST_TYPE' ) ) {
				define( 'LATEPOINT_CUSTOMER_POST_TYPE', 'latepoint_customer' );
			}

			if ( ! defined( 'LATEPOINT_DB_VERSION' ) ) {
				define( 'LATEPOINT_DB_VERSION', $this->db_version );
			}

			global $wpdb;
			if ( ! defined( 'LATEPOINT_TABLE_RECURRENCES' ) ) {
				define( 'LATEPOINT_TABLE_RECURRENCES', $wpdb->prefix . 'latepoint_recurrences' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_BUNDLES' ) ) {
				define( 'LATEPOINT_TABLE_BUNDLES', $wpdb->prefix . 'latepoint_bundles' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_BUNDLES_SERVICES' ) ) {
				define( 'LATEPOINT_TABLE_JOIN_BUNDLES_SERVICES', $wpdb->prefix . 'latepoint_bundles_services' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_BOOKINGS' ) ) {
				define( 'LATEPOINT_TABLE_BOOKINGS', $wpdb->prefix . 'latepoint_bookings' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_SESSIONS' ) ) {
				define( 'LATEPOINT_TABLE_SESSIONS', $wpdb->prefix . 'latepoint_sessions' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_SERVICES' ) ) {
				define( 'LATEPOINT_TABLE_SERVICES', $wpdb->prefix . 'latepoint_services' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_SETTINGS' ) ) {
				define( 'LATEPOINT_TABLE_SETTINGS', $wpdb->prefix . 'latepoint_settings' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_SERVICE_CATEGORIES' ) ) {
				define( 'LATEPOINT_TABLE_SERVICE_CATEGORIES', $wpdb->prefix . 'latepoint_service_categories' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_WORK_PERIODS' ) ) {
				define( 'LATEPOINT_TABLE_WORK_PERIODS', $wpdb->prefix . 'latepoint_work_periods' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_CUSTOM_PRICES' ) ) {
				define( 'LATEPOINT_TABLE_CUSTOM_PRICES', $wpdb->prefix . 'latepoint_custom_prices' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_AGENTS_SERVICES' ) ) {
				define( 'LATEPOINT_TABLE_AGENTS_SERVICES', $wpdb->prefix . 'latepoint_agents_services' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_ACTIVITIES' ) ) {
				define( 'LATEPOINT_TABLE_ACTIVITIES', $wpdb->prefix . 'latepoint_activities' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_TRANSACTIONS' ) ) {
				define( 'LATEPOINT_TABLE_TRANSACTIONS', $wpdb->prefix . 'latepoint_transactions' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_TRANSACTION_REFUNDS' ) ) {
				define( 'LATEPOINT_TABLE_TRANSACTION_REFUNDS', $wpdb->prefix . 'latepoint_transaction_refunds' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_TRANSACTION_INTENTS' ) ) {
				define( 'LATEPOINT_TABLE_TRANSACTION_INTENTS', $wpdb->prefix . 'latepoint_transaction_intents' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_AGENTS' ) ) {
				define( 'LATEPOINT_TABLE_AGENTS', $wpdb->prefix . 'latepoint_agents' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_CUSTOMERS' ) ) {
				define( 'LATEPOINT_TABLE_CUSTOMERS', $wpdb->prefix . 'latepoint_customers' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_CUSTOMER_META' ) ) {
				define( 'LATEPOINT_TABLE_CUSTOMER_META', $wpdb->prefix . 'latepoint_customer_meta' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_SERVICE_META' ) ) {
				define( 'LATEPOINT_TABLE_SERVICE_META', $wpdb->prefix . 'latepoint_service_meta' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_BOOKING_META' ) ) {
				define( 'LATEPOINT_TABLE_BOOKING_META', $wpdb->prefix . 'latepoint_booking_meta' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_AGENT_META' ) ) {
				define( 'LATEPOINT_TABLE_AGENT_META', $wpdb->prefix . 'latepoint_agent_meta' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_BUNDLE_META' ) ) {
				define( 'LATEPOINT_TABLE_BUNDLE_META', $wpdb->prefix . 'latepoint_bundle_meta' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_STEPS' ) ) {
				define( 'LATEPOINT_TABLE_STEPS', $wpdb->prefix . 'latepoint_steps' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_STEP_SETTINGS' ) ) {
				define( 'LATEPOINT_TABLE_STEP_SETTINGS', $wpdb->prefix . 'latepoint_step_settings' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_LOCATIONS' ) ) {
				define( 'LATEPOINT_TABLE_LOCATIONS', $wpdb->prefix . 'latepoint_locations' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_LOCATION_CATEGORIES' ) ) {
				define( 'LATEPOINT_TABLE_LOCATION_CATEGORIES', $wpdb->prefix . 'latepoint_location_categories' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_PROCESSES' ) ) {
				define( 'LATEPOINT_TABLE_PROCESSES', $wpdb->prefix . 'latepoint_processes' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_PROCESS_JOBS' ) ) {
				define( 'LATEPOINT_TABLE_PROCESS_JOBS', $wpdb->prefix . 'latepoint_process_jobs' );
			}

			if ( ! defined( 'LATEPOINT_TABLE_CARTS' ) ) {
				define( 'LATEPOINT_TABLE_CARTS', $wpdb->prefix . 'latepoint_carts' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_CART_META' ) ) {
				define( 'LATEPOINT_TABLE_CART_META', $wpdb->prefix . 'latepoint_cart_meta' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_CART_ITEMS' ) ) {
				define( 'LATEPOINT_TABLE_CART_ITEMS', $wpdb->prefix . 'latepoint_cart_items' );
			}

			if ( ! defined( 'LATEPOINT_TABLE_BLOCKED_PERIODS' ) ) {
				define( 'LATEPOINT_TABLE_BLOCKED_PERIODS', $wpdb->prefix . 'latepoint_blocked_periods' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_ORDERS' ) ) {
				define( 'LATEPOINT_TABLE_ORDERS', $wpdb->prefix . 'latepoint_orders' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_ORDER_META' ) ) {
				define( 'LATEPOINT_TABLE_ORDER_META', $wpdb->prefix . 'latepoint_order_meta' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_ORDER_ITEMS' ) ) {
				define( 'LATEPOINT_TABLE_ORDER_ITEMS', $wpdb->prefix . 'latepoint_order_items' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_ORDER_INTENTS' ) ) {
				define( 'LATEPOINT_TABLE_ORDER_INTENTS', $wpdb->prefix . 'latepoint_order_intents' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_ORDER_INTENT_META' ) ) {
				define( 'LATEPOINT_TABLE_ORDER_INTENT_META', $wpdb->prefix . 'latepoint_order_intent_meta' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_ORDER_INVOICES' ) ) {
				define( 'LATEPOINT_TABLE_ORDER_INVOICES', $wpdb->prefix . 'latepoint_order_invoices' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_PAYMENT_REQUESTS' ) ) {
				define( 'LATEPOINT_TABLE_PAYMENT_REQUESTS', $wpdb->prefix . 'latepoint_payment_requests' );
			}
			if ( ! defined( 'LATEPOINT_TABLE_CUSTOMER_OTP_CODES' ) ) {
				define( 'LATEPOINT_TABLE_CUSTOMER_OTP_CODES', $wpdb->prefix . 'latepoint_customer_otp_codes' );
			}
			if ( ! defined( 'LATEPOINT_CUSTOMER_OTP_CODE_STATUS_ACTIVE' ) ) {
				define( 'LATEPOINT_CUSTOMER_OTP_CODE_STATUS_ACTIVE', 'active' );
			}
			if ( ! defined( 'LATEPOINT_CUSTOMER_OTP_CODE_STATUS_USED' ) ) {
				define( 'LATEPOINT_CUSTOMER_OTP_CODE_STATUS_USED', 'used' );
			}
			if ( ! defined( 'LATEPOINT_CUSTOMER_OTP_CODE_STATUS_EXPIRED' ) ) {
				define( 'LATEPOINT_CUSTOMER_OTP_CODE_STATUS_EXPIRED', 'expired' );
			}
			if ( ! defined( 'LATEPOINT_CUSTOMER_OTP_CODE_STATUS_CANCELLED' ) ) {
				define( 'LATEPOINT_CUSTOMER_OTP_CODE_STATUS_CANCELLED', 'cancelled' );
			}
			if ( ! defined( 'LATEPOINT_ORDER_INTENT_STATUS_NEW' ) ) {
				define( 'LATEPOINT_ORDER_INTENT_STATUS_NEW', 'new' );
			}
			if ( ! defined( 'LATEPOINT_ORDER_INTENT_STATUS_CONVERTED' ) ) {
				define( 'LATEPOINT_ORDER_INTENT_STATUS_CONVERTED', 'converted' );
			}
			if ( ! defined( 'LATEPOINT_ORDER_INTENT_STATUS_PROCESSING' ) ) {
				define( 'LATEPOINT_ORDER_INTENT_STATUS_PROCESSING', 'processing' );
			}
			if ( ! defined( 'LATEPOINT_ORDER_INTENT_STATUS_FAILED' ) ) {
				define( 'LATEPOINT_ORDER_INTENT_STATUS_FAILED', 'failed' );
			}

			if ( ! defined( 'LATEPOINT_TRANSACTION_INTENT_STATUS_NEW' ) ) {
				define( 'LATEPOINT_TRANSACTION_INTENT_STATUS_NEW', 'new' );
			}
			if ( ! defined( 'LATEPOINT_TRANSACTION_INTENT_STATUS_CONVERTED' ) ) {
				define( 'LATEPOINT_TRANSACTION_INTENT_STATUS_CONVERTED', 'converted' );
			}
			if ( ! defined( 'LATEPOINT_TRANSACTION_INTENT_STATUS_PROCESSING' ) ) {
				define( 'LATEPOINT_TRANSACTION_INTENT_STATUS_PROCESSING', 'processing' );
			}
			if ( ! defined( 'LATEPOINT_TRANSACTION_INTENT_STATUS_FAILED' ) ) {
				define( 'LATEPOINT_TRANSACTION_INTENT_STATUS_FAILED', 'failed' );
			}

			if ( ! defined( 'LATEPOINT_BOOKING_STATUS_APPROVED' ) ) {
				define( 'LATEPOINT_BOOKING_STATUS_APPROVED', 'approved' );
			}
			if ( ! defined( 'LATEPOINT_BOOKING_STATUS_PENDING' ) ) {
				define( 'LATEPOINT_BOOKING_STATUS_PENDING', 'pending' );
			}
			if ( ! defined( 'LATEPOINT_BOOKING_STATUS_PAYMENT_PENDING' ) ) {
				define( 'LATEPOINT_BOOKING_STATUS_PAYMENT_PENDING', 'payment_pending' );
			}
			if ( ! defined( 'LATEPOINT_BOOKING_STATUS_CANCELLED' ) ) {
				define( 'LATEPOINT_BOOKING_STATUS_CANCELLED', 'cancelled' );
			}
			if ( ! defined( 'LATEPOINT_BOOKING_STATUS_NO_SHOW' ) ) {
				define( 'LATEPOINT_BOOKING_STATUS_NO_SHOW', 'no_show' );
			}
			if ( ! defined( 'LATEPOINT_BOOKING_STATUS_COMPLETED' ) ) {
				define( 'LATEPOINT_BOOKING_STATUS_COMPLETED', 'completed' );
			}

			if ( ! defined( 'LATEPOINT_JOB_STATUS_COMPLETED' ) ) {
				define( 'LATEPOINT_JOB_STATUS_COMPLETED', 'completed' );
			}
			if ( ! defined( 'LATEPOINT_JOB_STATUS_SCHEDULED' ) ) {
				define( 'LATEPOINT_JOB_STATUS_SCHEDULED', 'scheduled' );
			}
			if ( ! defined( 'LATEPOINT_JOB_STATUS_CANCELLED' ) ) {
				define( 'LATEPOINT_JOB_STATUS_CANCELLED', 'cancelled' );
			}
			if ( ! defined( 'LATEPOINT_JOB_STATUS_ERROR' ) ) {
				define( 'LATEPOINT_JOB_STATUS_ERROR', 'error' );
			}

			// order statuses
			if ( ! defined( 'LATEPOINT_ORDER_STATUS_OPEN' ) ) {
				define( 'LATEPOINT_ORDER_STATUS_OPEN', 'open' );
			}
			if ( ! defined( 'LATEPOINT_ORDER_STATUS_CANCELLED' ) ) {
				define( 'LATEPOINT_ORDER_STATUS_CANCELLED', 'cancelled' );
			}
			if ( ! defined( 'LATEPOINT_ORDER_STATUS_COMPLETED' ) ) {
				define( 'LATEPOINT_ORDER_STATUS_COMPLETED', 'completed' );
			}

			// order fulfillment statuses
			if ( ! defined( 'LATEPOINT_ORDER_FULFILLMENT_STATUS_NOT_FULFILLED' ) ) {
				define( 'LATEPOINT_ORDER_FULFILLMENT_STATUS_NOT_FULFILLED', 'not_fulfilled' );
			}
			if ( ! defined( 'LATEPOINT_ORDER_FULFILLMENT_STATUS_FULFILLED' ) ) {
				define( 'LATEPOINT_ORDER_FULFILLMENT_STATUS_FULFILLED', 'fulfilled' );
			}
			if ( ! defined( 'LATEPOINT_ORDER_FULFILLMENT_STATUS_PARTIALLY_FULFILLED' ) ) {
				define( 'LATEPOINT_ORDER_FULFILLMENT_STATUS_PARTIALLY_FULFILLED', 'partially_fulfilled' );
			}

			if ( ! defined( 'LATEPOINT_ORDER_PAYMENT_STATUS_NOT_PAID' ) ) {
				define( 'LATEPOINT_ORDER_PAYMENT_STATUS_NOT_PAID', 'not_paid' );
			}
			if ( ! defined( 'LATEPOINT_ORDER_PAYMENT_STATUS_PARTIALLY_PAID' ) ) {
				define( 'LATEPOINT_ORDER_PAYMENT_STATUS_PARTIALLY_PAID', 'partially_paid' );
			}
			if ( ! defined( 'LATEPOINT_ORDER_PAYMENT_STATUS_FULLY_PAID' ) ) {
				define( 'LATEPOINT_ORDER_PAYMENT_STATUS_FULLY_PAID', 'fully_paid' );
			}
			if ( ! defined( 'LATEPOINT_ORDER_PAYMENT_STATUS_PROCESSING' ) ) {
				define( 'LATEPOINT_ORDER_PAYMENT_STATUS_PROCESSING', 'processing' );
			}
			if ( ! defined( 'LATEPOINT_ORDER_PAYMENT_STATUS_REFUNDED' ) ) {
				define( 'LATEPOINT_ORDER_PAYMENT_STATUS_REFUNDED', 'refunded' );
			}
			if ( ! defined( 'LATEPOINT_ORDER_PAYMENT_STATUS_PARTIALLY_REFUNDED' ) ) {
				define( 'LATEPOINT_ORDER_PAYMENT_STATUS_PARTIALLY_REFUNDED', 'partially_refunded' );
			}

			if ( ! defined( 'LATEPOINT_DEFAULT_TIME_SYSTEM' ) ) {
				define( 'LATEPOINT_DEFAULT_TIME_SYSTEM', '12' );
			}
			if ( ! defined( 'LATEPOINT_DEFAULT_DATE_FORMAT' ) ) {
				define( 'LATEPOINT_DEFAULT_DATE_FORMAT', 'm/d/Y' );
			}
			if ( ! defined( 'LATEPOINT_DATETIME_DB_FORMAT' ) ) {
				define( 'LATEPOINT_DATETIME_DB_FORMAT', 'Y-m-d H:i:s' );
			}

			if ( ! defined( 'LATEPOINT_STATUS_ERROR' ) ) {
				define( 'LATEPOINT_STATUS_ERROR', 'error' );
			}
			if ( ! defined( 'LATEPOINT_STATUS_SUCCESS' ) ) {
				define( 'LATEPOINT_STATUS_SUCCESS', 'success' );
			}

			if ( ! defined( 'LATEPOINT_SERVICE_STATUS_ACTIVE' ) ) {
				define( 'LATEPOINT_SERVICE_STATUS_ACTIVE', 'active' );
			}
			if ( ! defined( 'LATEPOINT_SERVICE_STATUS_DISABLED' ) ) {
				define( 'LATEPOINT_SERVICE_STATUS_DISABLED', 'disabled' );
			}

			if ( ! defined( 'LATEPOINT_SERVICE_VISIBILITY_VISIBLE' ) ) {
				define( 'LATEPOINT_SERVICE_VISIBILITY_VISIBLE', 'visible' );
			}
			if ( ! defined( 'LATEPOINT_SERVICE_VISIBILITY_HIDDEN' ) ) {
				define( 'LATEPOINT_SERVICE_VISIBILITY_HIDDEN', 'hidden' );
			}


			if ( ! defined( 'LATEPOINT_LOCATION_STATUS_ACTIVE' ) ) {
				define( 'LATEPOINT_LOCATION_STATUS_ACTIVE', 'active' );
			}
			if ( ! defined( 'LATEPOINT_LOCATION_STATUS_DISABLED' ) ) {
				define( 'LATEPOINT_LOCATION_STATUS_DISABLED', 'disabled' );
			}

			if ( ! defined( 'LATEPOINT_AGENT_STATUS_ACTIVE' ) ) {
				define( 'LATEPOINT_AGENT_STATUS_ACTIVE', 'active' );
			}
			if ( ! defined( 'LATEPOINT_AGENT_STATUS_DISABLED' ) ) {
				define( 'LATEPOINT_AGENT_STATUS_DISABLED', 'disabled' );
			}

			if ( ! defined( 'LATEPOINT_BUNDLE_STATUS_ACTIVE' ) ) {
				define( 'LATEPOINT_BUNDLE_STATUS_ACTIVE', 'active' );
			}
			if ( ! defined( 'LATEPOINT_BUNDLE_STATUS_DISABLED' ) ) {
				define( 'LATEPOINT_BUNDLE_STATUS_DISABLED', 'disabled' );
			}

			if ( ! defined( 'LATEPOINT_BUNDLE_VISIBILITY_VISIBLE' ) ) {
				define( 'LATEPOINT_BUNDLE_VISIBILITY_VISIBLE', 'visible' );
			}
			if ( ! defined( 'LATEPOINT_BUNDLE_VISIBILITY_HIDDEN' ) ) {
				define( 'LATEPOINT_BUNDLE_VISIBILITY_HIDDEN', 'hidden' );
			}

			if ( ! defined( 'LATEPOINT_ITEM_VARIANT_BOOKING' ) ) {
				define( 'LATEPOINT_ITEM_VARIANT_BOOKING', 'booking' );
			}
			if ( ! defined( 'LATEPOINT_ITEM_VARIANT_BUNDLE' ) ) {
				define( 'LATEPOINT_ITEM_VARIANT_BUNDLE', 'bundle' );
			}

			if ( ! defined( 'LATEPOINT_DEFAULT_TIMEBLOCK_INTERVAL' ) ) {
				define( 'LATEPOINT_DEFAULT_TIMEBLOCK_INTERVAL', 30 );
			}
			if ( ! defined( 'LATEPOINT_DEFAULT_PHONE_CODE' ) ) {
				define( 'LATEPOINT_DEFAULT_PHONE_CODE', '+1' );
			}
			if ( ! defined( 'LATEPOINT_DEFAULT_PHONE_FORMAT' ) ) {
				define( 'LATEPOINT_DEFAULT_PHONE_FORMAT', '(999) 999-9999' );
			}

			if ( ! defined( 'LATEPOINT_TRANSACTION_STATUS_SUCCEEDED' ) ) {
				define( 'LATEPOINT_TRANSACTION_STATUS_SUCCEEDED', 'succeeded' );
			}
			if ( ! defined( 'LATEPOINT_TRANSACTION_STATUS_PROCESSING' ) ) {
				define( 'LATEPOINT_TRANSACTION_STATUS_PROCESSING', 'processing' );
			}
			if ( ! defined( 'LATEPOINT_TRANSACTION_STATUS_FAILED' ) ) {
				define( 'LATEPOINT_TRANSACTION_STATUS_FAILED', 'failed' );
			}

			// invoices
			if ( ! defined( 'LATEPOINT_INVOICE_STATUS_OPEN' ) ) {
				define( 'LATEPOINT_INVOICE_STATUS_OPEN', 'open' );
			}
			if ( ! defined( 'LATEPOINT_INVOICE_STATUS_PAID' ) ) {
				define( 'LATEPOINT_INVOICE_STATUS_PAID', 'paid' );
			}
			if ( ! defined( 'LATEPOINT_INVOICE_STATUS_PARTIALLY_PAID' ) ) {
				define( 'LATEPOINT_INVOICE_STATUS_PARTIALLY_PAID', 'partially_paid' );
			}
			if ( ! defined( 'LATEPOINT_INVOICE_STATUS_DRAFT' ) ) {
				define( 'LATEPOINT_INVOICE_STATUS_DRAFT', 'draft' );
			}
			if ( ! defined( 'LATEPOINT_INVOICE_STATUS_VOID' ) ) {
				define( 'LATEPOINT_INVOICE_STATUS_VOID', 'void' );
			}
			if ( ! defined( 'LATEPOINT_INVOICE_STATUS_UNCOLLECTIBLE' ) ) {
				define( 'LATEPOINT_INVOICE_STATUS_UNCOLLECTIBLE', 'uncollectible' );
			}

			// PAYMENTS

			if ( ! defined( 'LATEPOINT_PAYMENT_PROCESSOR_STRIPE' ) ) {
				define( 'LATEPOINT_PAYMENT_PROCESSOR_STRIPE', 'stripe' );
			}
			if ( ! defined( 'LATEPOINT_PAYMENT_PROCESSOR_BRAINTREE' ) ) {
				define( 'LATEPOINT_PAYMENT_PROCESSOR_BRAINTREE', 'braintree' );
			}
			if ( ! defined( 'LATEPOINT_PAYMENT_PROCESSOR_PAYPAL' ) ) {
				define( 'LATEPOINT_PAYMENT_PROCESSOR_PAYPAL', 'paypal' );
			}

			if ( ! defined( 'LATEPOINT_TRANSACTION_KIND_CAPTURE' ) ) {
				define( 'LATEPOINT_TRANSACTION_KIND_CAPTURE', 'capture' );
			}
			if ( ! defined( 'LATEPOINT_TRANSACTION_KIND_AUTHORIZATION' ) ) {
				define( 'LATEPOINT_TRANSACTION_KIND_AUTHORIZATION', 'authorization' );
			}
			if ( ! defined( 'LATEPOINT_TRANSACTION_KIND_VOID' ) ) {
				define( 'LATEPOINT_TRANSACTION_KIND_VOID', 'void' );
			}

			if ( ! defined( 'LATEPOINT_PAYMENT_METHOD_LOCAL' ) ) {
				define( 'LATEPOINT_PAYMENT_METHOD_LOCAL', 'local' );
			}
			if ( ! defined( 'LATEPOINT_PAYMENT_METHOD_PAYPAL' ) ) {
				define( 'LATEPOINT_PAYMENT_METHOD_PAYPAL', 'paypal' );
			}
			if ( ! defined( 'LATEPOINT_PAYMENT_METHOD_CARD' ) ) {
				define( 'LATEPOINT_PAYMENT_METHOD_CARD', 'card' );
			}

			if ( ! defined( 'LATEPOINT_PAYMENT_TIME_LATER' ) ) {
				define( 'LATEPOINT_PAYMENT_TIME_LATER', 'later' );
			}
			if ( ! defined( 'LATEPOINT_PAYMENT_TIME_NOW' ) ) {
				define( 'LATEPOINT_PAYMENT_TIME_NOW', 'now' );
			}

			if ( ! defined( 'LATEPOINT_VALUE_ON' ) ) {
				define( 'LATEPOINT_VALUE_ON', 'on' );
			}
			if ( ! defined( 'LATEPOINT_VALUE_OFF' ) ) {
				define( 'LATEPOINT_VALUE_OFF', 'off' );
			}

			if ( ! defined( 'LATEPOINT_STATUS_ACTIVE' ) ) {
				define( 'LATEPOINT_STATUS_ACTIVE', 'active' );
			}
			if ( ! defined( 'LATEPOINT_STATUS_DISABLED' ) ) {
				define( 'LATEPOINT_STATUS_DISABLED', 'disabled' );
			}

			if ( ! defined( 'LATEPOINT_PAYMENT_PORTION_FULL' ) ) {
				define( 'LATEPOINT_PAYMENT_PORTION_FULL', 'full' );
			}
			if ( ! defined( 'LATEPOINT_PAYMENT_PORTION_REMAINING' ) ) {
				define( 'LATEPOINT_PAYMENT_PORTION_REMAINING', 'remaining' );
			}
			if ( ! defined( 'LATEPOINT_PAYMENT_PORTION_DEPOSIT' ) ) {
				define( 'LATEPOINT_PAYMENT_PORTION_DEPOSIT', 'deposit' );
			}
			if ( ! defined( 'LATEPOINT_PAYMENT_PORTION_CUSTOM' ) ) {
				define( 'LATEPOINT_PAYMENT_PORTION_CUSTOM', 'custom' );
			}

			if ( ! defined( 'LATEPOINT_ANY_AGENT' ) ) {
				define( 'LATEPOINT_ANY_AGENT', 'any' );
			}
			if ( ! defined( 'LATEPOINT_ANY_LOCATION' ) ) {
				define( 'LATEPOINT_ANY_LOCATION', 'any' );
			}

			if ( ! defined( 'LATEPOINT_ANY_AGENT_ORDER_RANDOM' ) ) {
				define( 'LATEPOINT_ANY_AGENT_ORDER_RANDOM', 'random' );
			}
			if ( ! defined( 'LATEPOINT_ANY_AGENT_ORDER_PRICE_HIGH' ) ) {
				define( 'LATEPOINT_ANY_AGENT_ORDER_PRICE_HIGH', 'price_high' );
			}
			if ( ! defined( 'LATEPOINT_ANY_AGENT_ORDER_PRICE_LOW' ) ) {
				define( 'LATEPOINT_ANY_AGENT_ORDER_PRICE_LOW', 'price_low' );
			}
			if ( ! defined( 'LATEPOINT_ANY_AGENT_ORDER_BUSY_HIGH' ) ) {
				define( 'LATEPOINT_ANY_AGENT_ORDER_BUSY_HIGH', 'busy_high' );
			}
			if ( ! defined( 'LATEPOINT_ANY_AGENT_ORDER_BUSY_LOW' ) ) {
				define( 'LATEPOINT_ANY_AGENT_ORDER_BUSY_LOW', 'busy_low' );
			}
			if ( ! defined( 'LATEPOINT_RECURRING_BOOKINGS_UNFOLDED_COUNT' ) ) {
				define( 'LATEPOINT_RECURRING_BOOKINGS_UNFOLDED_COUNT', 5 );
			}

			if ( ! defined( 'LATEPOINT_ALL' ) ) {
				define( 'LATEPOINT_ALL', 'all' );
			}

			// Stripe Connect
			if ( ! defined( 'LATEPOINT_STRIPE_CONNECT_URL' ) ) {
				define( 'LATEPOINT_STRIPE_CONNECT_URL', 'https://app.latepoint.com' );
			}
		}


		/**
		 * Include required core files used in admin and on the frontend.
		 */
		public function includes() {

			// CONTROLLERS
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/pro_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/default_agent_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/activities_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/search_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/customers_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/services_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/carts_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/transactions_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/orders_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/auth_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/processes_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/process_jobs_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/settings_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/form_fields_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/bookings_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/dashboard_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/wizard_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/notifications_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/steps_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/calendars_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/booking_form_settings_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/integrations_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/customer_cabinet_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/manage_booking_by_key_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/manage_order_by_key_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/events_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/stripe_connect_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/invoices_controller.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/controllers/support_topics_controller.php' );


			// MODELS
			include_once( LATEPOINT_ABSPATH . 'lib/models/model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/meta_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/bundle_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/cart_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/cart_meta_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/cart_item_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/order_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/order_meta_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/order_item_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/activity_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/work_period_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/agent_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/service_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/connector_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/service_category_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/customer_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/settings_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/booking_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/step_settings_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/transaction_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/transaction_intent_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/transaction_refund_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/booking_meta_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/customer_meta_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/agent_meta_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/service_meta_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/bundle_meta_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/location_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/location_category_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/session_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/order_intent_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/order_intent_meta_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/process_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/process_job_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/join_bundles_services_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/invoice_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/payment_request_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/recurrence_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/off_period_model.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/models/otp_model.php' );


			// HELPERS
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/wp_datetime.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/router_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/sessions_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/auth_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/encrypt_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/license_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/form_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/migrations_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/util_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/debug_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/wp_user_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/menu_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/image_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/events_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/icalendar_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/version_specific_updates_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/calendar_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/meeting_systems_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/marketing_systems_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/short_links_systems_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/timeline_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/booking_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/order_intent_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/activities_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/settings_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/customer_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/customer_import_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/processes_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/agent_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/service_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/database_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/money_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/time_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/notifications_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/email_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/sms_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/whatsapp_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/styles_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/work_periods_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/bundles_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/carts_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/orders_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/replacer_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/payments_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/resource_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/meta_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/shortcodes_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/connector_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/location_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/csv_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/steps_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/params_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/process_jobs_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/blocks_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/roles_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/price_breakdown_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/stripe_connect_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/pages_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/elementor_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/bricks_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/transaction_intent_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/transaction_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/invoices_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/support_topics_helper.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/helpers/otp_helper.php' );

			// MISC
			include_once( LATEPOINT_ABSPATH . 'lib/misc/time_period.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/blocked_period.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/booked_period.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/stripe_connect_customer.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/booking_request.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/booking_resource.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/work_period.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/filter.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/booking_slot.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/process_event.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/process_action.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/role.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/user.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/step.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/misc/router.php' );

			// MAILERS
			include_once( LATEPOINT_ABSPATH . 'lib/mailers/mailer.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/mailers/agent_mailer.php' );
			include_once( LATEPOINT_ABSPATH . 'lib/mailers/customer_mailer.php' );


			do_action( 'latepoint_includes' );
		}


		/**
		 * Hook into actions and filters.
		 */
		public function init_hooks() {
			if(isset( $_GET['latepoint'] ) && $_GET['latepoint'] == 'instant' ){
				add_action( 'init', array( $this, 'public_route_call' ), 100 );
			}
			$siteurl = get_site_option( 'siteurl' );
			if ( $siteurl ) {
				$siteurl_hash = md5( $siteurl );
			} else {
				$siteurl_hash = '';
			}

			if ( ! defined( 'LATEPOINT_CUSTOMER_LOGGED_IN_COOKIE' ) ) {
				define( 'LATEPOINT_CUSTOMER_LOGGED_IN_COOKIE', 'latepoint_customer_logged_in_' . $siteurl_hash );
			}
			if ( ! defined( 'LATEPOINT_ADMIN_MENU_LAYOUT_STYLE_COOKIE' ) ) {
				define( 'LATEPOINT_ADMIN_MENU_LAYOUT_STYLE_COOKIE', 'latepoint_admin_menu_layout_style_' . $siteurl_hash );
			}
			if ( ! defined( 'LATEPOINT_SELECTED_TIMEZONE_COOKIE' ) ) {
				define( 'LATEPOINT_SELECTED_TIMEZONE_COOKIE', 'latepoint_selected_timezone_' . $siteurl_hash );
			}

			if ( ! defined( 'LATEPOINT_CART_COOKIE' ) ) {
				define( 'LATEPOINT_CART_COOKIE', 'latepoint_cart_' . $siteurl_hash );
			}


			// Activation hook
			register_activation_hook( __FILE__, array( $this, 'create_required_tables' ) );
			register_activation_hook( __FILE__, array( $this, 'on_activate' ) );
			register_deactivation_hook( __FILE__, [ $this, 'on_deactivate' ] );


			add_action( 'after_setup_theme', array( $this, 'setup_environment' ) );
			add_action( 'init', array( $this, 'init' ), 0 );
			add_action( 'init', array( $this, 'init_widgets' ), 11 );

			add_action( 'admin_menu', array( $this, 'init_menus' ) );
			add_action( 'wp_enqueue_scripts', array( $this, 'load_front_scripts_and_styles' ) );
			add_action( 'admin_enqueue_scripts', array( $this, 'load_admin_scripts_and_styles' ) );
			add_filter( 'admin_body_class', array( $this, 'add_admin_body_class' ), 40 );
			add_filter( 'body_class', array( $this, 'add_body_class' ) );

			add_filter( 'cron_schedules', [ $this, 'add_custom_cron_schedules' ] );

			// used for testing of localhost to prevent wordpress issues with getting files from local server
			if ( LATEPOINT_ALLOW_LOCAL_SERVER ) {
				add_filter( 'http_request_args', [ $this, 'disable_localhost_url_check_for_development' ] );
			}

			// Add Link to latepoint to admin bar
			add_action( 'admin_bar_menu', array( $this, 'add_latepoint_link_to_admin_bar' ), 999 );


			// fix for output buffering error in WP
			// remove_action( 'shutdown', 'wp_ob_end_flush_all', 1 );

			add_action( 'wp_loaded', array( $this, 'pre_route_call' ) );


			// Create router action
			// ajax
			add_action( 'wp_ajax_latepoint_route_call', array( $this, 'route_call' ) );
			add_action( 'wp_ajax_nopriv_latepoint_route_call', array( $this, 'route_call' ) );
			// admin custom post/get
			add_action( 'admin_post_latepoint_route_call', array( $this, 'route_call' ) );
			add_action( 'admin_post_nopriv_latepoint_route_call', array( $this, 'route_call' ) );

			// crons
			add_action( 'latepoint_clear_old_activity_logs', [ $this, 'clear_old_activity_logs' ] );


			add_action( 'latepoint_on_addon_activate', [ $this, 'addon_activated' ], 10, 2 );
			add_action( 'latepoint_on_addon_deactivate', [ $this, 'addon_deactivated' ], 10, 2 );


			add_action( 'latepoint_email_processor_settings', [ $this, 'email_processor_settings' ], 10, 2 );


			// Auth
			add_filter( 'login_redirect', [ $this, 'redirect_manager_and_agent_to_latepoint' ], 10, 3 );


			// But WordPress has a whitelist of variables it allows, so we must put it on that list
			add_action( 'query_vars', array( $this, 'front_route_query_vars' ) );

			// If this is done, we can access it later
			// This example checks very early in the process:
			// if the variable is set, we include our page and stop execution after it
			add_action( 'parse_request', array( $this, 'front_route_parse_request' ) );


			add_action( 'admin_init', array( $this, 'redirect_after_activation' ) );

			add_filter( 'display_post_states', 'OsPagesHelper::add_display_post_states', 10, 2 );

			// allow agents to access admin when woocommerce plugin is installed
			add_filter( 'woocommerce_prevent_admin_access', [
				$this,
				'woocommerce_allow_agent_to_access_admin'
			], 20, 1 );

			// plugin related hooks
			add_action( 'latepoint_model_save', [ $this, 'save_connected_wordpress_user' ] );

			// Stripe Connect

			add_filter( 'latepoint_payment_processors', 'OsStripeConnectHelper::register_payment_processor' );
			add_action( 'latepoint_payment_processor_settings', 'OsStripeConnectHelper::add_settings_fields', 10 );
			add_action( 'latepoint_step_payment__pay_content', 'OsStripeConnectHelper::output_payment_step_contents', 10 );
			add_action( 'latepoint_order_payment__pay_content_after', 'OsStripeConnectHelper::output_order_payment_pay_contents', 10 );

			add_filter( 'latepoint_convert_charge_amount_to_requirements', 'OsStripeConnectHelper::convert_charge_amount_to_requirements', 10, 2 );
			add_filter( 'latepoint_process_payment_for_order_intent', 'OsStripeConnectHelper::process_payment', 10, 2 );
			add_filter( 'latepoint_process_payment_for_transaction_intent', 'OsStripeConnectHelper::process_payment_for_transaction_intent', 10, 2 );
			add_filter( 'latepoint_transaction_intent_specs_charge_amount', 'OsStripeConnectHelper::convert_transaction_intent_charge_amount_to_specs', 10, 2 );

			add_filter( 'latepoint_get_all_payment_times', 'OsStripeConnectHelper::add_all_payment_methods_to_payment_times' );
			add_filter( 'latepoint_get_enabled_payment_times', 'OsStripeConnectHelper::add_enabled_payment_methods_to_payment_times' );
			add_filter( 'latepoint_transaction_is_refund_available', 'OsStripeConnectHelper::transaction_is_refund_available', 10, 2 );
			add_filter( 'latepoint_process_refund', 'OsStripeConnectHelper::process_refund', 10, 3 );
			add_filter( 'plugin_action_links', [ $this, 'add_upgrade_link' ], 10, 2 );


			add_action( 'latepoint_customer_edit_form_after', 'OsStripeConnectHelper::output_stripe_link_on_customer_quick_form' );

			add_action( 'save_post', 'OsBlockHelper::save_blocks_styles' );
			// misc
			add_action( 'latepoint_after_step_content', 'OsStepsHelper::output_preset_fields' );

			OsActivitiesHelper::init_hooks();
			OsProcessJobsHelper::init_hooks();

			do_action( 'latepoint_init_hooks' );
		}


		function add_custom_cron_schedules( $schedules ) {
			if ( ! isset( $schedules['latepoint_5_minutes'] ) ) {
				$schedules['latepoint_5_minutes'] = array(
					'interval' => 5 * 60,
					'display'  => __( 'Once every 5 minutes', 'latepoint' )
				);
			}

			return $schedules;
		}

		function add_upgrade_link( $links, $plugin_file ) {
			if ( plugin_basename( __FILE__ ) == $plugin_file ) {
				if(apply_filters('latepoint_show_upgrade_link_on_plugins_page', true, $plugin_file) ) {
					$custom_link = '<a class="latepoint-plugin-upgrade-premium-link" href="' . LATEPOINT_UPGRADE_URL . '">'.esc_html__('Get LatePoint Pro').'</a>';
					$links[]     = $custom_link;
				}
			}

			return $links;
		}

		function woocommerce_allow_agent_to_access_admin( $prevent_access ) {
			if ( OsAuthHelper::is_agent_logged_in() ) {
				$prevent_access = false;
			}

			return $prevent_access;
		}

		function email_processor_settings( $processor_code ) {
			if ( $processor_code == 'wp_mail' ) {
				echo '<div class="sub-section-row">
					      <div class="sub-section-label">
					        <h3>' . esc_html__( 'Email Settings', 'latepoint' ) . '</h3>
					      </div>
					      <div class="sub-section-content">
						      <div class="os-row">
										<div class="os-col-4">' . OsFormHelper::text_field( 'settings[notification_email_setting_from_name]', __( 'From Name', 'latepoint' ), OsSettingsHelper::get_settings_value( 'notification_email_setting_from_name', get_bloginfo( 'name' ) ), [ 'theme' => 'simple' ] ) . '</div>
										<div class="os-col-8">' . OsFormHelper::text_field( 'settings[notification_email_setting_from_email]', __( 'From Email Address', 'latepoint' ), OsSettingsHelper::get_settings_value( 'notification_email_setting_from_email', get_bloginfo( 'admin_email' ) ), [ 'theme' => 'simple' ] ) . '</div>
									</div>
								</div>
							</div>';
			}
		}

		public function save_connected_wordpress_user( $customer ) {
			if ( $customer->is_new_record() ) {
				return;
			}
			if ( $customer instanceof OsCustomerModel ) {
				if ( $customer->wordpress_user_id ) {
					// has connected wp user
					$wp_user = get_user_by( 'id', $customer->wordpress_user_id );
					if ( $wp_user && ! is_super_admin( $wp_user->ID ) ) {
						// update linked wordpress user
						if ( $customer->first_name && $customer->first_name != $wp_user->first_name ) {
							$wp_user->first_name = $customer->first_name;
						}
						if ( $customer->last_name && $customer->last_name != $wp_user->last_name ) {
							$wp_user->last_name = $customer->last_name;
						}
						if ( $customer->email && $customer->email != $wp_user->user_email ) {
							$wp_user->user_email = $customer->email;
						}
						$result = wp_update_user( $wp_user );
						if ( is_wp_error( $result ) ) {
							error_log( 'Error saving wp user' );
						} else {
							// update user cookies because their data has changed
						}
					}
				} else {
					if ( OsAuthHelper::can_wp_users_login_as_customers() ) {
						OsCustomerHelper::create_wp_user_for_customer( $customer );
					}
				}
			}
		}

		// used for testing of localhost to prevent wordpress issues with getting files from local server
		public function disable_localhost_url_check_for_development( $parsed_args ) {
			$parsed_args['reject_unsafe_urls'] = false;

			return $parsed_args;
		}

		/*
		 * Check if current user is Agent or Manager, automatically redirect to latepoint dashboard instead of default WordPress admin
		 */
		public function redirect_manager_and_agent_to_latepoint( $redirect_to, $request, $user ) {
			if ( $user && is_object( $user ) && is_a( $user, 'WP_User' ) ) {
				if ( $user->has_cap( 'edit_bookings' ) || $user->has_cap( 'manage_latepoint' ) ) {
					return OsRouterHelper::build_link( [ 'dashboard', 'index' ] );
				}
			}

			return $redirect_to;
		}


		public function clear_old_activity_logs() {
			if(OsSettingsHelper::is_on('should_clear_old_activity_log')){
				global $wpdb;
				$activity = new OsActivityModel();

				$now_datetime = OsTimeHelper::now_datetime_object();

				$cutoff   = $now_datetime->modify(  '-6 months' )->format( LATEPOINT_DATETIME_DB_FORMAT );
				$wpdb->query( $wpdb->prepare( "DELETE FROM %i WHERE `created_at` < %s", [ esc_sql( $activity->table_name ), $cutoff ] ) );
			}
		}

		public function addon_activated( $addon_name, $addon_version ) {
			OsDatabaseHelper::check_db_version_for_addons();
		}

		public function addon_deactivated( $addon_name, $addon_version ) {
			OsDatabaseHelper::delete_addon_info( $addon_name, $addon_version );
		}


		public function on_deactivate() {
			wp_clear_scheduled_hook( 'latepoint_check_if_addons_update_available' );
			wp_clear_scheduled_hook( 'latepoint_clear_old_activity_logs' );
		}

		function on_activate() {
			OsRolesHelper::register_roles_in_wp();

			if ( ! wp_next_scheduled( 'latepoint_check_if_addons_update_available' ) ) {
				wp_schedule_event( time(), 'daily', 'latepoint_check_if_addons_update_available' );
			}

			if ( ! wp_next_scheduled( 'latepoint_clear_old_activity_logs' ) ) {
				wp_schedule_event( time(), 'daily', 'latepoint_clear_old_activity_logs' );
			}

			// if wizard has not been visited yet - redirect to it
			if ( ! get_option( 'latepoint_wizard_visited', false ) ) {
				add_option( 'latepoint_redirect_to_wizard', true );
			}

			// create default location
			OsLocationHelper::get_default_location();

			# create default pages if not existing (customer cabinet)
			OsPagesHelper::create_predefined_pages();

			do_action( 'latepoint_on_activate', 'latepoint', $this->version );
		}

		function redirect_after_activation() {
			if ( get_option( 'latepoint_redirect_to_wizard', false ) ) {
				delete_option( 'latepoint_redirect_to_wizard' );
				if ( ! isset( $_GET['activate-multi'] ) ) {
					wp_redirect( OsRouterHelper::build_link( OsRouterHelper::build_route_name( 'wizard', 'setup' ) ) );
				}
			} elseif ( get_option( 'latepoint_show_version_5_modal', false ) ) {
				delete_option( 'latepoint_show_version_5_modal' );
				if ( ! isset( $_GET['activate-multi'] ) ) {
					wp_redirect( OsRouterHelper::build_link( OsRouterHelper::build_route_name( 'settings', 'version_5_intro' ) ) );
				}
			}
		}

		public function front_route_parse_request( $wp ) {
			if ( isset( $wp->query_vars['latepoint_is_custom_route'] ) ) {
				if ( isset( $wp->query_vars['route_name'] ) ) {
					$this->route_call();
				}
			}
		}

		public function front_route_query_vars( $query_vars ) {
			$query_vars[] = 'latepoint_booking_id';
			$query_vars[] = 'latepoint_is_custom_route';
			$query_vars[] = 'route_name';

			return $query_vars;
		}

		public function route_call() {
			$route_name = OsRouterHelper::get_request_param( 'route_name', OsRouterHelper::build_route_name( 'dashboard', 'index' ) );
			OsRouterHelper::call_by_route_name( $route_name, OsRouterHelper::get_request_param( 'return_format', 'html' ) );
		}

		public function public_route_call() {
			OsRouterHelper::call_by_route_name( OsRouterHelper::build_route_name('steps', 'start_instant'), OsRouterHelper::get_request_param( 'return_format', 'html' ) );
		}

		public function pre_route_call() {
			if ( OsRouterHelper::get_request_param( 'pre_route' ) ) {
				$this->route_call();
			}
		}


		/**
		 * Init LatePoint when WordPress Initialises.
		 */
		public function init() {
			OsAuthHelper::set_current_user();
			OsStepsHelper::init_step_actions();
			OsSettingsHelper::run_autoload();
			$this->register_post_types();
			$this->register_shortcodes();
			// Set up localisation.
			$this->load_plugin_textdomain();
			do_action( 'latepoint_init' );
			add_filter( 'http_request_host_is_external', '__return_true' );

			OsBlockHelper::register_blocks();
		}

		public function init_widgets() {
			OsElementorHelper::init();
			OsBricksHelper::init();
		}

		public function load_plugin_textdomain() {
			load_plugin_textdomain( 'latepoint', false, dirname( plugin_basename( __FILE__ ) ) . '/languages' );
		}


		/**
		 * Register a custom menu page.
		 */
		function init_menus() {
			// link for admins
			add_menu_page(
				__( 'LatePoint', 'latepoint' ),
				__( 'LatePoint', 'latepoint' ),
				OsAuthHelper::get_current_user()->wp_capability,
				'latepoint',
				[ $this, 'route_call' ],
				'none'
			);


		}


		function add_latepoint_link_to_admin_bar( $wp_admin_bar ) {
			if ( OsAuthHelper::get_current_user()->has_backend_access() ) {
				// build link depending on who is logged in
				$args = [
					'id'    => 'latepoint_top_link',
					'title' => '<span class="latepoint-icon latepoint-icon-lp-logo" style="margin-right: 7px;"></span><span style="">' . __( 'LatePoint', 'latepoint' ) . '</span>',
					'href'  => OsRouterHelper::build_link( [ 'dashboard', 'index' ] ),
					'meta'  => array( 'class' => '' )
				];
				$wp_admin_bar->add_node( $args );
			}
		}


		/**
		 * Register shortcodes
		 */
		public function register_shortcodes() {
			add_shortcode( 'latepoint_book_button', array( 'OsShortcodesHelper', 'shortcode_latepoint_book_button' ) );
			add_shortcode( 'latepoint_book_form', array( 'OsShortcodesHelper', 'shortcode_latepoint_book_form' ) );
			add_shortcode( 'latepoint_customer_dashboard', array(
				'OsShortcodesHelper',
				'shortcode_latepoint_customer_dashboard'
			) );
			add_shortcode( 'latepoint_customer_login', array(
				'OsShortcodesHelper',
				'shortcode_latepoint_customer_login'
			) );
			add_shortcode( 'latepoint_resources', array( 'OsShortcodesHelper', 'shortcode_latepoint_resources' ) );
			add_shortcode( 'latepoint_calendar', array( 'OsShortcodesHelper', 'shortcode_latepoint_calendar' ) );
		}

		/*

		 SHORTCODES

		*/


		public function setup_environment() {
			if ( ! current_theme_supports( 'post-thumbnails' ) ) {
				add_theme_support( 'post-thumbnails' );
			}
			add_post_type_support( LATEPOINT_AGENT_POST_TYPE, 'thumbnail' );
			add_post_type_support( LATEPOINT_SERVICE_POST_TYPE, 'thumbnail' );
			add_post_type_support( LATEPOINT_CUSTOMER_POST_TYPE, 'thumbnail' );
		}


		public function create_required_tables() {
			OsDatabaseHelper::run_setup();
		}


		/**
		 * Register core post types.
		 */
		public function register_post_types() {
		}


		/**
		 * Register scripts and styles - FRONT
		 */
		public function load_front_scripts_and_styles() {
			$localized_vars = [
				'route_action'                          => 'latepoint_route_call',
				'response_status'                       => [ 'success' => 'success', 'error' => 'error' ],
				'ajaxurl'                               => admin_url( 'admin-ajax.php' ),
				'time_pick_style'                       => OsStepsHelper::get_time_pick_style(),
				'string_today'                          => __( 'Today', 'latepoint' ),
				'reload_booking_form_summary_route'     => OsRouterHelper::build_route_name( 'steps', 'reload_booking_form_summary_panel' ),
				'time_system'                           => OsTimeHelper::get_time_system(),
				'msg_not_available'                     => __( 'Not Available', 'latepoint' ),
				'booking_button_route'                  => OsRouterHelper::build_route_name( 'steps', 'start' ),
				'remove_cart_item_route'                => OsRouterHelper::build_route_name( 'carts', 'remove_item_from_cart' ),
				'show_booking_end_time'                 => ( OsSettingsHelper::is_on( 'show_booking_end_time' ) ) ? 'yes' : 'no',
				'customer_dashboard_url'                => OsSettingsHelper::get_customer_dashboard_url( true ),
				'demo_mode'                             => OsSettingsHelper::is_env_demo(),
				'cancel_booking_prompt'                 => __( 'Are you sure you want to cancel this appointment?', 'latepoint' ),
				'single_space_message'                  => __( 'Space Available', 'latepoint' ),
				'many_spaces_message'                   => __( 'Spaces Available', 'latepoint' ),
				'body_font_family'                      => '"latepoint", -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif ',
				'headings_font_family'                  => '"latepoint", -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif ',
				'currency_symbol_before'                => OsSettingsHelper::get_settings_value( 'currency_symbol_before', '' ),
				'currency_symbol_after'                 => OsSettingsHelper::get_settings_value( 'currency_symbol_after', '' ),
				'thousand_separator'                    => OsSettingsHelper::get_settings_value( 'thousand_separator', ',' ),
				'decimal_separator'                     => OsSettingsHelper::get_settings_value( 'decimal_separator', '.' ),
				'number_of_decimals'                    => OsSettingsHelper::get_settings_value( 'number_of_decimals', '2' ),
				'included_phone_countries'              => wp_json_encode( OsSettingsHelper::get_included_phone_countries() ),
				'default_phone_country'                 => OsSettingsHelper::get_default_phone_country(),
				'is_timezone_selected'                  => OsTimeHelper::is_timezone_saved_in_session(),
				'start_from_order_intent_route'         => OsRouterHelper::build_route_name( 'steps', 'start_from_order_intent' ),
				'start_from_order_intent_key'           => OsRouterHelper::get_request_param( 'latepoint_order_intent_key' ) ? OsRouterHelper::get_request_param( 'latepoint_order_intent_key' ) : '',
				'is_enabled_show_dial_code_with_flag'   => OsSettingsHelper::is_enabled_show_dial_code_with_flag(),
				'mask_phone_number_fields'              => OsSettingsHelper::is_on( 'mask_phone_number_fields', LATEPOINT_VALUE_ON ),
				'msg_validation_presence'               => __( 'can not be blank', 'latepoint' ),
				'msg_validation_presence_checkbox'      => __( 'has to be checked', 'latepoint' ),
				'msg_validation_invalid'                => __( 'is invalid', 'latepoint' ),
				'msg_minutes_suffix'                    => __( ' minutes', 'latepoint' ),
				'is_stripe_connect_enabled'             => OsPaymentsHelper::is_payment_processor_enabled( OsStripeConnectHelper::$processor_code ),
				'check_order_intent_bookable_route'     => OsRouterHelper::build_route_name( 'steps', 'check_order_intent_bookable' ),
				'generate_timeslots_for_day_route'      => OsRouterHelper::build_route_name( 'steps', 'generate_timeslots_for_day' ),
				'payment_environment'                   => OsSettingsHelper::get_payments_environment(),
				'style_border_radius'                   => OsSettingsHelper::get_booking_form_border_radius(),
				'datepicker_timeslot_selected_label'    => __( 'Selected', 'latepoint' ),
				'invoices_payment_form_route'           => OsRouterHelper::build_route_name( 'invoices', 'payment_form' ),
				'invoices_summary_before_payment_route' => OsRouterHelper::build_route_name( 'invoices', 'summary_before_payment' ),
				'reset_presets_when_adding_new_item'    => OsSettingsHelper::is_on( 'reset_presets_when_adding_new_item' )
			];

			$localized_vars['start_from_transaction_access_key'] = '';
			if ( OsRouterHelper::get_request_param( 'latepoint_transaction_intent_key' ) ) {
				$invoice = OsInvoicesHelper::get_invoice_by_transaction_intent_key( OsRouterHelper::get_request_param( 'latepoint_transaction_intent_key' ) );
				if ( $invoice ) {
					$localized_vars['start_from_transaction_access_key'] = $invoice->access_key;
				}
			}

			if ( OsPaymentsHelper::is_payment_processor_enabled( OsStripeConnectHelper::$processor_code ) ) {
				$localized_vars['stripe_connect_key']          = OsStripeConnectHelper::get_connect_publishable_key();
				$localized_vars['stripe_connected_account_id'] = OsStripeConnectHelper::get_connect_account_id();
			}
			$localized_vars['stripe_connect_route_create_payment_intent']                        = OsRouterHelper::build_route_name( 'stripe_connect', 'create_payment_intent' );
			$localized_vars['stripe_connect_route_create_payment_intent_for_transaction_intent'] = OsRouterHelper::build_route_name( 'stripe_connect', 'create_payment_intent_for_transaction' );

			// Stylesheets
			wp_enqueue_style('latepoint-main-front', $this->public_stylesheets() . 'front.css', false, $this->version);

			// add styles from options if gutenberg blocks exists
			OsBlockHelper::add_block_styles_to_page();

			// Javscripts

			// Addon scripts and styles
			do_action( 'latepoint_wp_enqueue_scripts' );

			if ( OsPaymentsHelper::is_payment_processor_enabled( OsStripeConnectHelper::$processor_code ) ) {
				wp_enqueue_script( 'stripe', 'https://js.stripe.com/v3/', false, null );
			}

			wp_register_script( 'latepoint-vendor-front', $this->public_javascripts() . 'vendor-front.js', [ 'jquery' ], $this->version );
			wp_register_script( 'latepoint-main-front', $this->public_javascripts() . 'front.js', [
				'jquery',
				'latepoint-vendor-front',
				'wp-i18n'
			], $this->version );


			$localized_vars = apply_filters( 'latepoint_localized_vars_front', $localized_vars );

			wp_localize_script( 'latepoint-main-front', 'latepoint_helper', $localized_vars );
			wp_enqueue_script( 'latepoint-main-front' );


			$latepoint_css_variables = OsStylesHelper::generate_css_variables();
			wp_add_inline_style( 'latepoint-main-front', $latepoint_css_variables );
		}

		public function add_admin_body_class( $classes ) {
			if ( ( is_admin() ) && isset( $_GET['page'] ) && $_GET['page'] == 'latepoint' ) {
				$classes = $classes . ' latepoint-admin latepoint';
			}

			return $classes;
		}

		public function add_body_class( $classes ) {
			$classes[] = 'latepoint';

			return $classes;
		}


		/**
		 * Register admin scripts and styles - ADMIN
		 */
		public function load_admin_scripts_and_styles() {
			// Stylesheets
			wp_enqueue_style( 'latepoint-blocks-editor', LatePoint::plugin_url() . 'blocks/assets/css/editor-styles.css', array( 'wp-edit-blocks' ), $this->version );
			wp_enqueue_style( 'latepoint-main-admin', $this->public_stylesheets() . 'admin.css', false, $this->version );

			// Javscripts
			wp_enqueue_media();


			wp_enqueue_script( 'latepoint-vendor-admin', $this->public_javascripts() . 'vendor-admin.js', [ 'jquery' ], $this->version );
			wp_enqueue_script( 'latepoint-main-admin', $this->public_javascripts() . 'admin.js', [
				'jquery',
				'latepoint-vendor-admin',
				'wp-i18n'
			], $this->version );


			do_action( 'latepoint_admin_enqueue_scripts' );

			$localized_vars = [
				'route_action'                        => 'latepoint_route_call',
				'response_status'                     => [ 'success' => 'success', 'error' => 'error' ],
				'ajaxurl'                             => admin_url( 'admin-ajax.php' ),
				'value_all'                           => LATEPOINT_ALL,
				'value_on'                            => LATEPOINT_VALUE_ON,
				'value_off'                           => LATEPOINT_VALUE_OFF,
				'body_font_family'                    => '"latepoint", -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif ',
				'headings_font_family'                => '"latepoint", -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif ',
				'wp_locale'                           => get_locale(),
				'string_today'                        => __( 'Today', 'latepoint' ),
				'click_to_copy_done'                  => __( 'Copied', 'latepoint' ),
				'click_to_copy_prompt'                => __( 'Just click to copy', 'latepoint' ),
				'approve_confirm'                     => __( 'Are you sure you want to approve this booking?', 'latepoint' ),
				'reject_confirm'                      => __( 'Are you sure you want to reject this booking?', 'latepoint' ),
				'time_system'                         => OsTimeHelper::get_time_system(),
				'msg_not_available'                   => __( 'Not Available', 'latepoint' ),
				'msg_addon_activated'                 => __( 'Active', 'latepoint' ),
				'datepicker_timeslot_selected_label'  => __( 'Selected', 'latepoint' ),
				'string_minutes'                      => __( 'minutes', 'latepoint' ),
				'single_space_message'                => __( 'Space Available', 'latepoint' ),
				'many_spaces_message'                 => __( 'Spaces Available', 'latepoint' ),
				'currency_symbol_before'              => OsSettingsHelper::get_settings_value( 'currency_symbol_before', '' ),
				'currency_symbol_after'               => OsSettingsHelper::get_settings_value( 'currency_symbol_after', '' ),
				'thousand_separator'                  => OsSettingsHelper::get_settings_value( 'thousand_separator', ',' ),
				'decimal_separator'                   => OsSettingsHelper::get_settings_value( 'decimal_separator', '.' ),
				'number_of_decimals'                  => OsSettingsHelper::get_settings_value( 'number_of_decimals', '2' ),
				'included_phone_countries'            => wp_json_encode( OsSettingsHelper::get_included_phone_countries() ),
				'default_phone_country'               => OsSettingsHelper::get_default_phone_country(),
				'date_format'                         => OsSettingsHelper::get_date_format(),
				'date_format_for_js'                  => OsSettingsHelper::get_date_format_for_js(),
				'is_enabled_show_dial_code_with_flag' => OsSettingsHelper::is_enabled_show_dial_code_with_flag(),
				'mask_phone_number_fields'            => OsSettingsHelper::is_on( 'mask_phone_number_fields', LATEPOINT_VALUE_ON ),
				'msg_validation_presence'             => __( 'can not be blank', 'latepoint' ),
				'msg_validation_presence_checkbox'    => __( 'has to be checked', 'latepoint' ),
				'msg_validation_invalid'              => __( 'is invalid', 'latepoint' ),
				'msg_minutes_suffix'                  => __( ' minutes', 'latepoint' ),
				'order_item_variant_booking'          => LATEPOINT_ITEM_VARIANT_BOOKING,
				'order_item_variant_bundle'           => LATEPOINT_ITEM_VARIANT_BUNDLE
			];

			// Add block related variables
			$localized_vars = array_merge( $localized_vars, OsBlockHelper::localized_vars_for_blocks() );

			/**
			 * Array of localized variables to be available in latepoint_helper object in admin
			 *
			 * @param {array} $localized_vars The default array being filtered
			 * @returns {array} The filtered array of localized variables
			 *
			 * @since 5.0.0
			 * @hook latepoint_localized_vars_admin
			 *
			 */
			$localized_vars = apply_filters( 'latepoint_localized_vars_admin', $localized_vars );

			wp_localize_script( 'latepoint-main-admin', 'latepoint_helper', $localized_vars );


			$latepoint_css_variables = OsStylesHelper::generate_css_variables();
			wp_add_inline_style( 'latepoint-main-admin', $latepoint_css_variables );

		}

	}
endif;


$LATEPOINT = new LatePoint();


